
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Í∞ÑÎã®RPG</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öîÔ∏è</text></svg>">
  <style>
    :root {
      --primary-bg: #2c3e50;
      --secondary-bg: #34495e;
      --border-color: #7f8c8d;
      --text-color: #ecf0f1;
      --player-hp-color: #2ecc71;
      --monster-hp-color: #e74c3c;
      --xp-bar-color: #3498db;
      --button-bg: #3498db;
      --button-hover-bg: #2980b9;
      --button-disabled-bg: #95a5a6;
      --skill-learned-bg: #27ae60;
      --skill-learnable-bg: #f1c40f;
      --skill-locked-bg: #7f8c8d;
      --skill-maxed-bg: #e67e22;
      --disenchant-color: #9b59b6;
      --enchant-color: #e67e22;
      --rebirth-color: #e74c3c;
      --survival-color: #1abc9c;

      --rarity-common: #ecf0f1;
      --rarity-uncommon: #2ecc71;
      --rarity-rare: #3498db;
      --rarity-legendary: #f39c12;
      --rarity-mythic: #e74c3c;
      --rarity-ultimate: #00e6e6;
      --rarity-eternal: #ff66ff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: var(--primary-bg);
      color: var(--text-color);
      user-select: none;
      transition: background-color 0.3s, color 0.3s;
    }

    #root {
      width: 100%;
      max-width: 400px;
      height: 100%;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      box-sizing: border-box;
      background-color: var(--secondary-bg);
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .screen-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    .town-screen {
        justify-content: space-around;
    }

    .town-screen .player-card {
        margin: 0.8rem 0;
    }

    /* Difficulty & Class Selection */
    .difficulty-selection,
    .class-selection {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        width: 100%;
        margin-top: 1.2rem;
    }
    .difficulty-card,
    .class-card {
        background-color: rgba(0,0,0,0.2);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.8rem;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.2s;
        color: var(--text-color);
        font-family: inherit;
        text-align: left;
        width: 100%;
        box-sizing: border-box;
    }
    .difficulty-card:hover,
    .class-card:hover {
        background-color: var(--secondary-bg);
        transform: translateY(-3px);
    }
    .difficulty-card h2,
    .class-card h2 {
        margin: 0 0 0.4rem 0;
        color: var(--button-bg);
        font-size: 1.2rem;
    }
    .difficulty-card p,
    .class-card p {
        margin: 0;
        font-size: 0.75rem;
        line-height: 1.4;
    }


    h1 {
      margin-bottom: 0.8rem;
      font-size: 2rem;
    }

    h2.inventory-full {
        color: var(--monster-hp-color);
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }


    .logo {
        font-size: 2.8rem;
        font-weight: 700;
        color: var(--skill-learnable-bg);
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 10px var(--rarity-legendary);
        margin-bottom: 1.5rem;
        letter-spacing: 2px;
    }

    p {
      line-height: 1.5;
    }

    #game-world {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }

    .character-card {
        background-color: rgba(0,0,0,0.2);
        padding: 0.8rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: background-color 0.3s;
    }

    .character-card h2 {
        margin: 0 0 0.4rem 0;
        font-size: 1.2rem;
        white-space: pre-wrap;
    }

    .player-header {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 0.4rem;
    }

    .player-header h2 {
        margin: 0;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        align-items: center;
    }
    .player-class {
        color: #bdc3c7;
        font-size: 0.8rem;
    }
    .inventory-warning {
        color: var(--monster-hp-color);
        font-weight: bold;
        font-size: 0.7rem;
    }

    .dungeon-progress {
        text-align: center;
        font-weight: bold;
        color: var(--xp-bar-color);
        margin: 0 0 0.4rem 0 !important;
        padding-bottom: 0.4rem;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
    }

    .hp-bar-container, .xp-bar-container {
        width: 100%;
        height: 16px;
        background-color: #2c3e50;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        margin-top: 0.4rem;
        transition: background-color 0.3s;
    }

    .hp-bar, .xp-bar {
        height: 100%;
        transition: width 0.3s ease-in-out;
    }

    .player-card .hp-bar {
        background-color: var(--player-hp-color);
    }

    .monster-card .hp-bar {
        background-color: var(--monster-hp-color);
    }

    .xp-bar {
        background-color: var(--xp-bar-color);
    }

    .character-card p {
        margin: 0.4rem 0 0 0;
        text-align: right;
        font-weight: bold;
        font-size: 0.75rem;
    }

    .gold-display {
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 0.8rem;
    }

    .gold-sp-display {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .gold-sp-display p {
        margin: 0;
    }
    .gold-sp-display.top-display {
        width: 100%;
        flex-direction: row;
        justify-content: space-around;
        background: rgba(0,0,0,0.2);
        padding: 0.4rem;
        border-radius: 8px;
        margin-bottom: 0.8rem;
        transition: background-color 0.3s;
    }


    .player-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.4rem;
        justify-content: space-around;
        margin-top: 0.8rem;
        padding-top: 0.6rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.8rem;
        font-weight: bold;
    }
    .player-equipment {
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.4rem;
        margin-top: 0.4rem;
        padding-top: 0.4rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.75rem;
        text-align: center;
    }

    .ultimate-skill-display {
        grid-column: 1 / -1;
        margin-top: 0.4rem;
        padding-top: 0.4rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.75rem;
        text-align: center;
    }

    .player-buffs {
        grid-column: 1 / -1;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: 0.4rem;
        justify-content: center;
    }
    .buff-icon {
        background-color: var(--button-bg);
        color: white;
        padding: 0.15rem 0.3rem;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: bold;
    }

    .status-effects {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.4rem;
        min-height: 18px;
    }
    .status-effect-icon {
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        padding: 0.1rem 0.3rem;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: bold;
    }

    #message-log {
        width: 100%;
        height: 120px;
        background-color: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 0.4rem 0.8rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column-reverse;
        box-sizing: border-box;
        border: 1px solid var(--border-color);
        margin: 0.8rem 0;
        transition: background-color 0.3s;
    }

    #message-log p {
        margin: 0.2rem 0;
        font-size: 0.75rem;
        border-bottom: 1px solid #4a637e;
        padding-bottom: 0.2rem;
    }
    #message-log p:first-child {
        border-bottom: none;
    }

    #action-buttons {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 0.4rem;
    }
    .town-actions {
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
    }

    .town-actions .button {
        padding: 0.5rem;
        font-size: 0.75rem;
    }


    .button {
      padding: 0.65rem;
      font-size: 0.8rem;
      font-weight: bold;
      color: white;
      background-color: var(--button-bg);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      text-align: center;
      white-space: nowrap;
      position: relative;
    }

    .button:hover {
      background-color: var(--button-hover-bg);
    }

    .button:active {
      transform: scale(0.98);
    }

    .button:disabled {
        background-color: var(--button-disabled-bg);
        cursor: not-allowed;
        transform: none;
    }

    .button:disabled:hover {
        background-color: var(--button-disabled-bg);
    }

    .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background-color: var(--monster-hp-color);
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.7rem;
        font-weight: bold;
        box-shadow: 0 0 4px rgba(0,0,0,0.5);
    }


    /* Shop & etc. Styles */
    .shop-container, .skill-tree-screen, .rebirth-screen, .survival-shop-screen {
        justify-content: flex-start;
        padding-top: 0.8rem;
    }
    .shop-items, .skill-list, .rebirth-upgrades, .survival-items {
        width: 100%;
        margin-top: 0.8rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        overflow-y: auto;
        flex-grow: 1;
    }
    .shop-item, .rebirth-upgrade-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(0,0,0,0.2);
        padding: 0.6rem 0.8rem;
        border-radius: 8px;
        transition: background-color 0.3s;
    }
    .shop-item span, .rebirth-upgrade-info h3 {
        font-size: 0.8rem;
        font-weight: 500;
        margin: 0;
    }
    .shop-item .item-class {
        font-size: 0.65rem;
        color: var(--border-color);
        margin-left: 0.4rem;
    }

    .shop-item .button, .rebirth-upgrade-item .button {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
        min-width: 65px;
    }
    #back-to-town {
        margin-top: auto;
        width: 100%;
    }

    .shop-filters {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-bottom: 0.8rem;
    }
    .filter-group {
        display: flex;
        gap: 0.4rem;
        background: rgba(0,0,0,0.2);
        padding: 0.4rem;
        border-radius: 8px;
        transition: background-color 0.3s;
    }
    .filter-btn {
        flex-grow: 1;
        padding: 0.3rem;
        font-size: 0.7rem;
        color: var(--text-color);
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s, color 0.2s;
    }
    .filter-btn:hover {
        background-color: var(--primary-bg);
    }
    .filter-btn.active {
        background-color: var(--button-bg);
        border-color: var(--button-hover-bg);
        font-weight: bold;
        color: white;
    }

    /* Equipment Screen Styles */
    .equipment-screen {
        justify-content: flex-start;
    }
    .equipment-screen h1 {
        margin-bottom: 0.4rem;
        font-size: 1.5rem;
    }
    .equipment-screen h2 {
        margin-top: 1.2rem;
        margin-bottom: 0.4rem;
        font-size: 1.2rem;
    }

    .equipment-slots {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem;
        width: 100%;
        margin: 0.8rem 0 0 0;
    }
    .slot-container h3 {
        margin: 0 0 0.4rem 0;
        font-size: 0.8rem;
    }
    .inventory-grid {
        width: 100%;
        flex-grow: 1;
        overflow-y: auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.4rem;
        padding: 0.4rem;
        background-color: rgba(0,0,0,0.2);
        border-radius: 8px;
        border: 2px solid transparent;
        transition: border-color 0.3s;
        min-height: 120px;
    }
    .item-card {
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.6rem;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s, border-color 0.2s;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }
    .item-card:hover {
        background-color: var(--primary-bg);
    }
    .item-card.empty {
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--border-color);
        font-style: italic;
        cursor: default;
        font-size: 0.75rem;
        min-height: 80px;
    }
    .item-card.empty:hover {
        background-color: var(--secondary-bg);
    }
    .item-card.restricted {
        opacity: 0.6;
    }
    .restricted-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        color: var(--monster-hp-color);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 0.8rem;
        border-radius: 8px;
        pointer-events: none;
    }
    .item-card .item-name {
        font-weight: bold;
        margin: 0;
        font-size: 0.8rem;
    }
    .item-card .item-class {
        font-size: 0.65rem;
        color: var(--border-color);
        font-style: italic;
        margin: 0;
    }
    .item-card .item-stats {
        font-size: 0.65rem;
        color: #bdc3c7;
        margin: 0;
    }
    .item-card .item-enchantment {
        font-size: 0.7rem;
        font-weight: bold;
        color: var(--enchant-color);
        margin-top: 0.2rem;
    }

    .equipment-screen-footer {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.8rem;
        margin-top: auto;
        padding-top: 0.8rem;
    }


    /* Blacksmith Screen Styles */
    .blacksmith-screen {
        justify-content: flex-start;
    }
    .blacksmith-screen h1 { margin-bottom: 0.4rem; }
    .blacksmith-tabs {
        display: flex;
        width: 100%;
        margin-bottom: 0.8rem;
    }
    .tab-button {
        flex: 1;
        padding: 0.6rem;
        font-size: 0.7rem;
        font-weight: bold;
        color: var(--text-color);
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        border-bottom-width: 2px;
    }
    .tab-button:first-child {
        border-top-left-radius: 8px;
    }
    .tab-button:last-child {
        border-top-right-radius: 8px;
    }
    .tab-button:not(:first-child) {
        border-left: none;
    }
    .tab-button.active {
        background-color: var(--primary-bg);
        border-bottom: 2px solid var(--button-bg);
    }

    #blacksmith-content {
        width: 100%;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .enhancement-slots {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.8rem;
        width: 100%;
        margin-bottom: 0.8rem;
    }
    .enhancement-slot {
        text-align: center;
    }
    .enhancement-slot h3 {
        margin: 0 0 0.4rem;
        font-size: 0.9rem;
    }
    #enhancement-details {
        width: 100%;
        min-height: 120px;
        background-color: rgba(0,0,0,0.2);
        border-radius: 8px;
        padding: 0.8rem;
        box-sizing: border-box;
        transition: background-color 0.3s;
    }
    #enhancement-details h3 {
        margin: 0 0 0.8rem;
        color: var(--xp-bar-color);
        font-size: 1.1rem;
    }
    .enhancement-info {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-bottom: 0.8rem;
    }
    .info-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
    }
    .cost-display {
        font-weight: bold;
    }
    .next-stats {
        display: flex;
        gap: 0.4rem;
        font-weight: bold;
        color: var(--player-hp-color);
    }
    .penalty-info {
        font-size: 0.65rem;
        color: var(--monster-hp-color);
        margin: 0 0 0.8rem;
    }
    #enhance-button, #enchant-button {
        width: 100%;
    }
    .current-enchantment {
        font-size: 0.75rem;
        color: var(--enchant-color);
        margin-bottom: 0.4rem;
        font-style: italic;
    }
    .enchant-warning {
        font-size: 0.65rem;
        color: var(--skill-learnable-bg);
        margin: 0 0 0.8rem;
    }

    /* Disenchant Styles */
    .blacksmith-screen h2 { margin: 0 0 0.4rem 0; font-size: 1rem; }
    .inventory-grid.disenchant-mode {
        border-color: var(--disenchant-color);
    }
    .item-card.disenchantable:hover {
        box-shadow: 0 0 8px var(--disenchant-color);
    }
    .disenchant-overlay {
        position: absolute;
        bottom: 0; left: 0; right: 0;
        background: linear-gradient(to top, var(--disenchant-color), transparent);
        color: white;
        text-align: center;
        font-weight: bold;
        font-size: 0.75rem;
        padding: 1rem 0 0.2rem 0;
        pointer-events: none;
    }

    /* Transcendence Styles */
    .transcendence-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 0.8rem;
    }
    .transcendence-main {
      display: flex;
      align-items: center;
      justify-content: space-around;
      background-color: rgba(0,0,0,0.2);
      padding: 0.8rem;
      border-radius: 8px;
    }
    .transcendence-slots {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .transcendence-slot {
      width: 100px;
      height: 120px;
    }
    .transcendence-symbol {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--border-color);
      padding: 0 0.4rem;
    }
    .transcendence-result-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
      text-align: center;
      min-width: 100px;
    }
    .transcendence-result-area .item-card {
        cursor: default;
    }
    .transcendence-result-area .item-card:hover {
        background-color: var(--secondary-bg);
    }
    .transcendence-result-area .button {
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
    }
    .transcendence-result-area p { margin: 0; font-size: 0.75rem; font-weight: bold; }

    .inventory-grid.transcendence-mode .item-card.unselectable {
      opacity: 0.4;
      cursor: not-allowed;
      background-color: var(--primary-bg);
    }
    .inventory-grid.transcendence-mode .item-card.unselectable:hover {
        box-shadow: none;
    }
    .inventory-grid.transcendence-mode .item-card.selected {
      border-color: var(--skill-learnable-bg);
      box-shadow: 0 0 8px var(--skill-learnable-bg);
    }


    /* Skill Tree Styles */
    .skill-node {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(0,0,0,0.2);
        padding: 0.6rem 0.8rem;
        border-radius: 8px;
        border-left: 4px solid var(--skill-locked-bg);
        transition: background-color 0.3s;
    }
    .skill-node.learnable { border-color: var(--skill-learnable-bg); }
    .skill-node.learned { border-color: var(--skill-learned-bg); }
    .skill-node.maxed { border-color: var(--skill-maxed-bg); }

    .skill-node.locked {
        opacity: 0.6;
    }

    .skill-info {
        text-align: left;
        flex-grow: 1;
    }
    .skill-info h3 {
        margin: 0 0 0.2rem;
        font-size: 0.9rem;
    }
    .skill-info p {
        margin: 0 0 0.2rem;
        font-size: 0.75rem;
    }
    .skill-info small {
        font-size: 0.65rem;
        color: var(--border-color);
    }
    .learn-skill-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
        min-width: 70px;
    }
    .skill-node.learnable .learn-skill-btn {
        background-color: var(--skill-learnable-bg);
        color: #2c3e50;
    }


    /* Quest Screen Styles */
    .quest-screen {
        justify-content: flex-start;
    }
    .quest-screen h1 {
        margin-bottom: 0;
    }
    .quest-list {
        width: 100%;
        flex-grow: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }
    .quest-item {
        display: flex;
        justify-content: space-between;
        align-items: stretch;
        background-color: rgba(0,0,0,0.2);
        border-radius: 8px;
        padding: 0.8rem;
        gap: 0.8rem;
        transition: background-color 0.3s;
    }
    .quest-info {
        flex-grow: 1;
        text-align: left;
    }
    .quest-description {
        font-weight: bold;
        font-size: 0.9rem;
        margin: 0 0 0.4rem 0;
    }
    .quest-progress-bar-container {
        height: 10px;
        background-color: var(--primary-bg);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 0.2rem;
    }
    .quest-progress-bar {
        height: 100%;
        background-color: var(--xp-bar-color);
        transition: width 0.3s;
    }
    .quest-progress-text {
        font-size: 0.65rem;
        text-align: right;
        margin: 0 0 0.4rem 0;
        color: var(--border-color);
    }
    .quest-reward {
        font-size: 0.75rem;
        margin: 0;
        font-weight: bold;
    }
    .quest-action {
        display: flex;
        align-items: center;
    }
    .quest-action .button {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
    }

    .quest-tabs {
        display: flex;
        width: 100%;
        margin: 0.8rem 0;
    }


    /* Rarity Colors */
    .rarity-common { color: var(--rarity-common); }
    .rarity-uncommon { color: var(--rarity-uncommon); }
    .rarity-rare { color: var(--rarity-rare); }
    .rarity-legendary { color: var(--rarity-legendary); }
    .rarity-mythic { color: var(--rarity-mythic); }
    .rarity-ultimate { color: var(--rarity-ultimate); }
    .rarity-eternal { color: var(--rarity-eternal); text-shadow: 0 0 5px var(--rarity-eternal); }

    #message-log .rarity-uncommon, #message-log .rarity-rare, #message-log .rarity-legendary, #message-log .rarity-mythic, #message-log .rarity-ultimate, #message-log .rarity-eternal {
        font-weight: bold;
    }
    
    #creator-credit {
        position: fixed;
        top: 10px;
        right: 10px;
        font-size: 0.7rem;
        color: var(--border-color);
        z-index: 1000;
    }

    /* Rebirth screen styles */
    .rebirth-info {
        background: rgba(0,0,0,0.2);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        width: 100%;
        box-sizing: border-box;
        transition: background-color 0.3s;
    }
    .rebirth-info p {
        margin: 0.5rem 0;
        font-size: 0.9rem;
    }
    .rebirth-points {
        color: var(--rebirth-color);
        font-weight: bold;
    }
    .rebirth-upgrade-info p {
        font-size: 0.8rem;
        margin: 0;
    }

    /* Guide Button & Modal Styles */
    #guide-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background-color: var(--skill-learnable-bg);
        color: var(--primary-bg);
        border-radius: 50%;
        border: none;
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
        transition: transform 0.2s;
    }
    #guide-button:hover {
        transform: scale(1.1);
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none; /* Initially hidden */
        justify-content: center;
        align-items: center;
        z-index: 2000;
        padding: 1rem;
        box-sizing: border-box;
    }

    .modal-content {
        background-color: var(--primary-bg);
        padding: 1.5rem;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        height: 90%;
        max-height: 700px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .modal-content h2 {
        color: var(--xp-bar-color);
        text-align: center;
        margin-top: 0;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
    }

    .modal-body {
        overflow-y: auto;
        flex-grow: 1;
    }

    .modal-body h3 {
        color: var(--skill-learnable-bg);
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    .modal-body p, .modal-body li {
        font-size: 0.85rem;
        line-height: 1.6;
        color: var(--text-color);
    }
    .modal-body ul {
        padding-left: 1.2rem;
    }

    .modal-footer {
        margin-top: 1rem;
        text-align: center;
    }

    /* Dungeon Map Styles */
    .dungeon-map {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
      margin-bottom: 0.8rem;
      padding: 0.4rem;
      background-color: rgba(0,0,0,0.2);
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    .map-node {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: var(--secondary-bg);
      border: 2px solid var(--border-color);
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
      transition: all 0.3s;
    }
    .map-node.cleared {
      background-color: var(--button-disabled-bg);
      border-color: var(--secondary-bg);
    }
    .map-node.current {
      background-color: var(--player-hp-color);
      border-color: var(--text-color);
      transform: scale(1.2);
      box-shadow: 0 0 8px var(--player-hp-color);
    }
    .map-node.boss {
      background-color: var(--monster-hp-color);
      border-color: #ff7675;
      transform: scale(1.3);
    }
    .map-node.boss.current {
        transform: scale(1.5);
        box-shadow: 0 0 10px var(--monster-hp-color);
    }

    /* Name Change Icon Styles */
    .name-change-icon {
        cursor: pointer;
        font-size: 1rem;
        margin-left: 0.4rem;
        display: inline-block;
        transition: transform 0.2s;
    }
    .name-change-icon:hover {
        transform: scale(1.2);
    }

    /* Item Lock & Batch Disenchant Styles */
    .lock-icon {
        position: absolute;
        top: 4px;
        right: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        z-index: 2;
        background: rgba(0,0,0,0.4);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.2s;
    }
    .lock-icon:hover {
        transform: scale(1.2);
    }

    .item-card.locked {
        border-color: var(--skill-learnable-bg);
        box-shadow: 0 0 4px var(--skill-learnable-bg);
    }

    .batch-disenchant-container {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        width: 100%;
    }
    .batch-disenchant-filters {
        background: rgba(0,0,0,0.2);
        padding: 0.8rem;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
    }
    .batch-disenchant-filters h3 {
        margin: 0 0 0.4rem 0;
        font-size: 1rem;
        text-align: center;
    }
    .filter-checkbox-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }
    .filter-checkbox-group label {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.8rem;
        cursor: pointer;
        background: var(--secondary-bg);
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }
    .filter-checkbox-group input:checked + span {
        color: var(--skill-learnable-bg);
        font-weight: bold;
    }
    .batch-disenchant-summary {
        background: rgba(0,0,0,0.2);
        padding: 0.8rem;
        border-radius: 8px;
        text-align: left;
    }
    .batch-disenchant-summary p {
        margin: 0.2rem 0;
        font-size: 0.8rem;
    }
    .batch-disenchant-summary strong {
        color: var(--xp-bar-color);
    }
    #batch-disenchant-button {
        background-color: var(--disenchant-color);
        margin-top: 0.4rem;
    }
    #batch-disenchant-button:hover {
        background-color: #8e44ad;
    }
    input[type="checkbox"] {
        display: none;
    }

    /* Permanent UI Styles */
    #game-reset-button {
        position: fixed;
        top: 10px;
        left: 10px;
        background-color: var(--monster-hp-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.3rem 0.6rem;
        font-size: 0.7rem;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
        transition: background-color 0.2s;
    }
    #game-reset-button:hover {
        background-color: #c0392b;
    }

    #rank-display {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: rgba(0,0,0,0.6);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        z-index: 1001;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    #rank-display span:first-child {
        font-size: 0.8rem;
        color: var(--text-color);
    }
    #rank-display span:last-child {
        font-size: 1.3rem;
        font-weight: bold;
    }
    .rank-C { color: #bdc3c7; }
    .rank-B { color: var(--rarity-uncommon); }
    .rank-A { color: var(--rarity-rare); }
    .rank-S { color: var(--rarity-legendary); }
    .rank-SS { color: var(--rarity-mythic); }
    .rank-SSS { color: var(--disenchant-color); }
  </style>
</head>
<body>
  <div id="creator-credit">Ï†úÏûëÏûê:ÌïúÍµ≠Ïù∏Ïù¥ÎùºÎ©¥</div>
  <div id="root"></div>
  <script type="module">
    /**
     * @license
     * SPDX-License-Identifier: Apache-2.0
     */

    const root = document.getElementById('root');
    if (!root) {
      throw new Error('Could not find root element');
    }

    // --- Game Constants ---
    const CRIT_MULTIPLIER = 1.5;
    const POTION_HEAL_PERCENT = 0.6;
    const POTION_COST = 50;
    const ATTACK_POTION_COST = 100;
    const DEFEAT_GOLD_PENALTY = 0.1;
    const ESCAPE_GOLD_PENALTY = 0.05;
    const CLASS_CHANGE_COST = 5000;
    const REBIRTH_LEVEL_REQ = 30;
    const GACHA_COST_SINGLE = 200;
    const GACHA_COST_TEN = 1800;
    const GACHA_COST_PROB_UP = 1000;
    const INVENTORY_LIMIT = 100;

    const STATUS_EFFECT_DEFINITIONS = {
        poison: { name: 'ÎèÖ', icon: '‚ò†Ô∏è' },
        burn: { name: 'ÌôîÏÉÅ', icon: 'üî•' },
        stun: { name: 'Í∏∞Ï†à', icon: 'üí´' },
        weaken: { name: 'ÏïΩÌôî', icon: '‚Üì' },
        vulnerable: { name: 'Ï∑®ÏïΩ', icon: 'üõ°Ô∏èüí•' },
    };

    const CLASSES = {
        'Ï†ÑÏÇ¨': { emoji: 'üõ°Ô∏è', baseHp: 160, baseAtk: 12, baseDef: 4, weapon: 'Í≤Ä', crit: 0.1, evade: 0.05 },
        'ÎßàÎ≤ïÏÇ¨': { emoji: 'üî•', baseHp: 110, baseAtk: 16, baseDef: 0, weapon: 'ÏßÄÌå°Ïù¥', crit: 0.1, evade: 0.05 },
        'ÏïîÏÇ¥Ïûê': { emoji: 'üí®', baseHp: 120, baseAtk: 14, baseDef: 1, weapon: 'Îã®Í≤Ä', crit: 0.30, evade: 0.20 },
        'Í∂ÅÏàò': { emoji: 'üèπ', baseHp: 115, baseAtk: 15, baseDef: 2, weapon: 'Ìôú', crit: 0.20, evade: 0.10 },
    };

    const DIFFICULTY_SETTINGS = {
        'Ïâ¨ÏõÄ': { monsterHpMod: 0.8, monsterAtkMod: 0.8, startGold: 50, startPotions: 5, startAttackPotions: 2, rewardMod: 0.8 },
        'Î≥¥ÌÜµ': { monsterHpMod: 1.05, monsterAtkMod: 1.05, startGold: 20, startPotions: 2, startAttackPotions: 1, rewardMod: 1.0 },
        'Ïñ¥Î†§ÏõÄ': { monsterHpMod: 1.35, monsterAtkMod: 1.35, startGold: 0, startPotions: 1, startAttackPotions: 0, rewardMod: 1.25 },
        'ÌïòÎìúÏΩîÏñ¥': { monsterHpMod: 2.0, monsterAtkMod: 2.0, startGold: 0, startPotions: 0, startAttackPotions: 0, rewardMod: 2.0, isHardcore: true },
    };

    const ULTIMATE_SKILLS = {
        'Ï†ÑÏÇ¨': {
            id: 'w_ultimate',
            name: 'Ï≤†ÏòπÏÑ±',
            cooldown: 5,
            description: level => `Í≥µÍ≤©Î†•Ïùò 200% ÌîºÌï¥Î•º Ï£ºÍ≥†, ${2+level}ÌÑ¥ ÎèôÏïà Î∞©Ïñ¥Î†•Ïù¥ ${30 + level * 5}% Ï¶ùÍ∞ÄÌïòÎäî 'Ï≤†Î≤Ω' Ìö®Í≥ºÎ•º ÏñªÏäµÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 2.0,
                buff: { name: 'Ï≤†Î≤Ω', stat: 'defense', value: 0.30 + level * 0.05, duration: 2 + level, isPercent: true },
                message: 'üõ°Ô∏è Í∞ïÏ≤†Ïùò ÏùòÏßÄ! [Ï≤†ÏòπÏÑ±]ÏùÑ Î∞úÎèôÌïòÏó¨ Ï†ÅÏóêÍ≤å Ï∞∏Í≤©ÏùÑ ÎÇ†Î¶¨Í≥†, Î™∏Ïù¥ Í∞ïÏ≤†Ï≤òÎüº Îã®Îã®Ìï¥Ï°åÎã§!'
            })
        },
        'ÎßàÎ≤ïÏÇ¨': {
            id: 'm_ultimate',
            name: 'Î©îÌÖåÏò§',
            cooldown: 5,
            description: level => `Í≥µÍ≤©Î†•Ïùò ${250 + level*20}% ÌîºÌï¥Î•º ÏûÖÌûàÍ≥†, 3ÌÑ¥Í∞Ñ ÌÑ¥ÎßàÎã§ ${10 + level * 3}Ïùò ÌôîÏÉÅ ÌîºÌï¥Î•º Ï§çÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 2.5 + level * 0.2,
                statusEffect: { type: 'burn', chance: 1.0, duration: 3, potency: 10 + level * 3 },
                message: '‚òÑÔ∏è ÌïòÎäòÏù¥ Î∂âÍ≤å Î¨ºÎì†Îã§! Í±∞ÎåÄÌïú [Î©îÌÖåÏò§]Í∞Ä Îñ®Ïñ¥Ï†∏ Ï†ÅÏùÑ Î∂àÌÉúÏö∞Í≥† ÏßÄÎ©¥ÏùÑ ÎÖπÏù∏Îã§!'
            })
        },
        'ÏïîÏÇ¥Ïûê': {
            id: 'r_ultimate',
            name: 'Í∑∏Î¶ºÏûê ÏäµÍ≤©',
            cooldown: 5,
            description: level => `Í≥µÍ≤©Î†•Ïùò ${180 + level*10}% ÌîºÌï¥Î•º 2Î≤à ÏûÖÌûàÍ≥†, 3ÌÑ¥Í∞Ñ ÌÑ¥ÎßàÎã§ ${8 + level * 2}Ïùò ÎèÖ ÌîºÌï¥Î•º Ï§çÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 1.8 + level * 0.1, // This is per hit
                statusEffect: { type: 'poison', chance: 1.0, duration: 3, potency: 8 + level * 2 },
                message: 'üí® Ïñ¥Îë† ÏÜçÏóêÏÑú Î≤àÎú©Ïù¥Îäî ÏπºÎÇ†! [Í∑∏Î¶ºÏûê ÏäµÍ≤©]ÏúºÎ°ú Ï†ÅÏùò Î∞∞ÌõÑÎ•º 2Ìöå Í∞ïÌÉÄÌïòÍ≥† ÎßπÎèÖÏùÑ Ï£ºÏûÖÌñàÎã§!'
            })
        },
        'Í∂ÅÏàò': {
            id: 'a_ultimate',
            name: 'ÏßëÏ§ë ÏÇ¨Í≤©',
            cooldown: 5,
            description: level => `Í≥µÍ≤©Î†•Ïùò ${220 + level*15}% ÌîºÌï¥Î•º ÏûÖÌûàÍ≥†, Îã§Ïùå 2ÌÑ¥Í∞Ñ ÏπòÎ™ÖÌÉÄ ÌôïÎ•†Ïù¥ ${15 + level*5}% Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 2.2 + level * 0.15,
                buff: { name: 'ÏßëÏ§ë', stat: 'critChance', value: 0.15 + level * 0.05, duration: 2, isPercent: false },
                message: 'üèπ Ïà®ÏùÑ Î©àÏ∂îÍ≥† ÏãúÏúÑÎ•º ÎãπÍ∏¥Îã§! [ÏßëÏ§ë ÏÇ¨Í≤©]Ïù¥ Ï†ÅÏùò Í∏âÏÜåÎ•º Íø∞Îö´ÏóàÎã§!'
            })
        },
    };
    
    const ULTIMATE_SKILLS_2 = {
        'Ï†ÑÏÇ¨': {
            id: 'w_ultimate_2',
            name: 'Î∂ÑÏáÑ',
            cooldown: 6,
            description: level => `Í≥µÍ≤©Î†•Ïùò 250% ÌîºÌï¥Î•º Ï£ºÍ≥†, 2ÌÑ¥Í∞Ñ Ï†ÅÏùÑ [Ï∑®ÏïΩ] ÏÉÅÌÉúÎ°ú ÎßåÎì§Ïñ¥ Î∞õÎäî ÌîºÌï¥Î•º ${20 + level * 5}% Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 2.5,
                statusEffect: { type: 'vulnerable', chance: 1.0, duration: 2, potency: 0.20 + level * 0.05 },
                message: 'ÎïÖÏù¥ ÌùîÎì§Î¶∞Îã§! [Î∂ÑÏáÑ]Ïùò ÏùºÍ≤©Ïù¥ Ï†ÅÏùò Î∞©Ïñ¥Î•º ÏÇ∞ÏÇ∞Ï°∞Í∞ÅÎÉàÎã§!'
            })
        },
        'ÎßàÎ≤ïÏÇ¨': {
            id: 'm_ultimate_2',
            name: 'ÏÑúÎ¶¨ Í≥†Î¶¨',
            cooldown: 6,
            description: level => `Í≥µÍ≤©Î†•Ïùò 120% ÌîºÌï¥Î•º Ï£ºÍ≥†, ${70 + level * 10}% ÌôïÎ•†Î°ú 1ÌÑ¥Í∞Ñ Ï†ÅÏùÑ [Í∏∞Ï†à]ÏãúÌÇµÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 1.2,
                statusEffect: { type: 'stun', chance: 0.7 + level * 0.1, duration: 1, potency: 0 },
                message: 'ÎÉâÍ∏∞Í∞Ä ÌúòÎ™∞ÏïÑÏπúÎã§! [ÏÑúÎ¶¨ Í≥†Î¶¨]Í∞Ä Ï†ÅÏùÑ Í∑∏ ÏûêÎ¶¨Ïóê ÏñºÏñ¥Î∂ôÍ≤å ÌñàÎã§!'
            })
        },
        'ÏïîÏÇ¥Ïûê': {
            id: 'r_ultimate_2',
            name: 'Ïó∞ÎßâÌÉÑ',
            cooldown: 6,
            description: level => `Ï¶âÏãú [ÌöåÌîº] ÏÉÅÌÉúÍ∞Ä ÎêòÏñ¥ Îã§Ïùå 2ÌÑ¥Í∞Ñ ÌöåÌîº ÌôïÎ•†Ïù¥ ${50 + level*10}% Ï¶ùÍ∞ÄÌïòÍ≥†, Îã§Ïùå 1ÌöåÏùò Í≥µÍ≤©Ïù¥ Î∞òÎìúÏãú ÏπòÎ™ÖÌÉÄÎ°ú Ï†ÅÏ§ëÌï©ÎãàÎã§.`,
            effect: level => ({
                buff: { stat: 'evadeChance', value: 0.50 + level * 0.1, duration: 2, isPercent: false },
                buff2: { name: 'ÌôïÏ†ï ÏπòÎ™ÖÌÉÄ', duration: 2, effect: { guaranteedCrit: true } },
                message: 'Ïó∞Í∏∞ ÏÜçÏúºÎ°ú ÏÇ¨ÎùºÏßÑÎã§! [Ïó∞ÎßâÌÉÑ]ÏùÑ ÏÇ¨Ïö©Ìï¥, Îã§Ïùå Í≥µÍ≤©ÏùÑ Ï§ÄÎπÑÌïúÎã§!'
            })
        },
        'Í∂ÅÏàò': {
            id: 'a_ultimate_2',
            name: 'ÌôîÏÇ¥ÎπÑ',
            cooldown: 6,
            description: level => `Í≥µÍ≤©Î†•Ïùò 100% ÌîºÌï¥Î•º 3Î≤à ÏûÖÌûàÍ≥†, ${50 + level*10}% ÌôïÎ•†Î°ú 2ÌÑ¥Í∞Ñ Ï†ÅÏùÑ [ÏïΩÌôî] ÏÉÅÌÉúÎ°ú ÎßåÎì≠ÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 1.0, // Per hit
                hits: 3,
                statusEffect: { type: 'weaken', chance: 0.5 + level * 0.1, duration: 2, potency: 0.15 },
                message: 'üéØ ÌïòÎäòÏù¥ ÌôîÏÇ¥Î°ú Îí§ÎçÆÏù∏Îã§! [ÌôîÏÇ¥ÎπÑ]Í∞Ä Ï†ÅÏßÑÏùÑ Ï¥àÌÜ†ÌôîÏãúÌÇ®Îã§!'
            })
        },
    };

    const ULTIMATE_SKILLS_3 = {
        'Ï†ÑÏÇ¨': {
            id: 'w_ultimate_3',
            name: 'Í¥ëÏ†ÑÏÇ¨Ïùò Ìè¨Ìö®',
            cooldown: 7,
            description: level => `3ÌÑ¥Í∞Ñ Í≥µÍ≤©Î†•Ïù¥ ${50 + level * 10}% Ï¶ùÍ∞ÄÌïòÏßÄÎßå Î∞©Ïñ¥Î†•Ïù¥ 50% Í∞êÏÜåÌï©ÎãàÎã§.`,
            effect: level => ({
                buff: { name: 'Í¥ëÌè≠Ìôî', stat: 'attackPower', value: 0.50 + level * 0.1, duration: 3, isPercent: true },
                debuff: { name: 'Î∞©Ïñ¥ ÏïΩÌôî', stat: 'defense', value: -0.5, duration: 3, isPercent: true },
                message: 'ÌÅ¨ÏïÑÏïÑÏïÑ! [Í¥ëÏ†ÑÏÇ¨Ïùò Ìè¨Ìö®]ÏôÄ Ìï®Íªò ÌïèÎπõ Í¥ëÍ∏∞Í∞Ä Ïò®Î™∏ÏùÑ Ìú©ÏãºÎã§!'
            })
        },
        'ÎßàÎ≤ïÏÇ¨': {
            id: 'm_ultimate_3',
            name: 'Ïó∞ÏáÑ Î≤àÍ∞ú',
            cooldown: 7,
            description: level => `Ï†ÅÏóêÍ≤å Í≥µÍ≤©Î†•Ïùò 150% ÌîºÌï¥Î•º Ï£ºÍ≥†, ${2 + level}Î≤à ÌäïÍ∏∞Î©∞ ÌîºÌï¥ÎüâÏù¥ 25%Ïî© Í∞êÏÜåÌï©ÎãàÎã§.`,
            effect: level => ({
                hits: 3 + level,
                initialDamageMultiplier: 1.5,
                damageFalloff: 0.75, // Each bounce deals 75% of the previous one's damage
                message: 'ÌååÏßÄÏßÄÏßÅ! [Ïó∞ÏáÑ Î≤àÍ∞ú]Í∞Ä Ï†ÅÎì§ ÏÇ¨Ïù¥Î•º Í∞ÄÎ•¥Î©∞ ÌÉÄÏò§Î•∏Îã§!'
            })
        },
        'ÏïîÏÇ¥Ïûê': {
            id: 'r_ultimate_3',
            name: 'Ïã¨Ïû• Ï∞åÎ•¥Í∏∞',
            cooldown: 7,
            description: level => `Í≥µÍ≤©Î†•Ïùò 300% ÌîºÌï¥Î•º Ï§çÎãàÎã§. Ï†ÅÏùò ÏûÉÏùÄ Ï≤¥Î†• 1%Îãπ ÌîºÌï¥ÎüâÏù¥ ${0.5 + level * 0.1}%Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 3.0,
                executeMultiplier: 0.005 + level * 0.001,
                message: 'Í∏âÏÜåÎ•º ÎÖ∏Î¶∞ ÏùºÍ≤©! [Ïã¨Ïû• Ï∞åÎ•¥Í∏∞]Í∞Ä Ï†ÅÏùò Ïà®ÌÜµÏùÑ ÎÅäÏúºÎ†§ ÌïúÎã§!'
            })
        },
        'Í∂ÅÏàò': {
            id: 'a_ultimate_3',
            name: 'Íø∞Îö´Îäî ÌôîÏÇ¥',
            cooldown: 7,
            description: level => `Í≥µÍ≤©Î†•Ïùò 350% ÌîºÌï¥Î•º Ï£ºÍ≥†, Ï†ÅÏùò Î∞©Ïñ¥Î†•ÏùÑ ${25 + level * 5}% Î¨¥ÏãúÌï©ÎãàÎã§.`,
            effect: level => ({
                damageMultiplier: 3.5,
                defensePenetration: 0.25 + level * 0.05,
                message: 'Î™®Îì† Í≤ÉÏùÑ Íø∞Îö´Îäî Ìïú Î∞ú! [Íø∞Îö´Îäî ÌôîÏÇ¥]Ïù¥ Ï†ÅÏùò Î∞©Ïñ¥Î•º Î¨¥Î†•ÌôîÏãúÌÇ®Îã§!'
            })
        },
    };

    const SKILL_DATA = {
        'Ï†ÑÏÇ¨': {
            'w_hp_1': { id: 'w_hp_1', name: 'Í∞ïÍ±¥Ìïú Ïú°Ï≤¥', description: level => `ÏµúÎåÄ ÏÉùÎ™ÖÎ†•Ïù¥ Î†àÎ≤®Îãπ 15Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level*15})`, cost: level => 100 * (level + 1), prerequisites: [], effects: level => [{ stat: 'maxHp', value: 15 * level }] },
            'w_atk_1': { id: 'w_atk_1', name: 'Î¨¥Í∏∞ Ïó∞Îßà', description: level => `Í≥µÍ≤©Î†•Ïù¥ Î†àÎ≤®Îãπ 2Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level*2})`, cost: level => 120 * (level + 1), prerequisites: [], effects: level => [{ stat: 'attackPower', value: 2 * level }] },
            'w_def_1': { id: 'w_def_1', name: 'Î∞©Ïñ¥Íµ¨ Í∞ïÌôî', description: level => `Î∞©Ïñ¥Î†•Ïù¥ Î†àÎ≤®Îãπ 1Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level*1})`, cost: level => 150 * (level + 1), prerequisites: [{id: 'w_hp_1', level: 1}], effects: level => [{ stat: 'defense', value: 1 * level }] },
            'w_ult_1': { id: 'w_ult_1', name: 'Ï≤†ÏòπÏÑ± Í∞ïÌôî', description: level => `Ï≤†ÏòπÏÑ±Ïùò Î∞©Ïñ¥Î†• Ï¶ùÍ∞Ä Ìö®Í≥ºÍ∞Ä Î†àÎ≤®Îãπ 5%Ïî© Ï∂îÍ∞ÄÎê©ÎãàÎã§.`, cost: level => 500 * (level + 1), prerequisites: [{id: 'w_def_1', level: 2}], effects: level => [] },
            'w_ult_2': { id: 'w_ult_2', name: 'Î∂ÑÏáÑ', maxLevel: 3, description: ULTIMATE_SKILLS_2['Ï†ÑÏÇ¨'].description, cost: level => 2000 * (level + 1), prerequisites: [{id: 'w_ult_1', level: 1}], effects: level => [] },
            'w_ult_3': { id: 'w_ult_3', name: 'Í¥ëÏ†ÑÏÇ¨Ïùò Ìè¨Ìö®', maxLevel: 3, description: ULTIMATE_SKILLS_3['Ï†ÑÏÇ¨'].description, cost: level => 5000 * (level + 1), prerequisites: [{id: 'w_ult_2', level: 1}], effects: level => [] },
        },
        'ÎßàÎ≤ïÏÇ¨': {
            'm_atk_1': { id: 'm_atk_1', name: 'ÎπÑÏ†ÑÎ†• Ï¶ùÌè≠', description: level => `Í≥µÍ≤©Î†•Ïù¥ Î†àÎ≤®Îãπ 3Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level*3})`, cost: level => 120 * (level + 1), prerequisites: [], effects: level => [{ stat: 'attackPower', value: 3 * level }] },
            'm_hp_1': { id: 'm_hp_1', name: 'ÏõêÏÜå Î≥¥Ìò∏Îßâ', description: level => `ÏµúÎåÄ ÏÉùÎ™ÖÎ†•Ïù¥ Î†àÎ≤®Îãπ 10Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level*10})`, cost: level => 100 * (level + 1), prerequisites: [], effects: level => [{ stat: 'maxHp', value: 10 * level }] },
            'm_burn_1': { id: 'm_burn_1', name: 'ÌÉÄÏò§Î•¥Îäî Î∂àÍΩÉ', description: level => `Î™®Îì† ÌôîÏÉÅ ÌîºÌï¥Í∞Ä Î†àÎ≤®Îãπ 10%Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`, cost: level => 300 * (level + 1), prerequisites: [{id: 'm_atk_1', level: 1}], effects: level => [] },
            'm_ult_1': { id: 'm_ult_1', name: 'Î©îÌÖåÏò§ Í∞ïÌôî', description: level => `Î©îÌÖåÏò§Ïùò Í∏∞Î≥∏ ÌîºÌï¥ÎüâÏù¥ Î†àÎ≤®Îãπ 10%Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`, cost: level => 500 * (level + 1), prerequisites: [{id: 'm_burn_1', level: 1}], effects: level => [] },
            'm_ult_2': { id: 'm_ult_2', name: 'ÏÑúÎ¶¨ Í≥†Î¶¨', maxLevel: 3, description: ULTIMATE_SKILLS_2['ÎßàÎ≤ïÏÇ¨'].description, cost: level => 2000 * (level + 1), prerequisites: [{id: 'm_ult_1', level: 1}], effects: level => [] },
            'm_ult_3': { id: 'm_ult_3', name: 'Ïó∞ÏáÑ Î≤àÍ∞ú', maxLevel: 3, description: ULTIMATE_SKILLS_3['ÎßàÎ≤ïÏÇ¨'].description, cost: level => 5000 * (level + 1), prerequisites: [{id: 'm_ult_2', level: 1}], effects: level => [] },
        },
        'ÏïîÏÇ¥Ïûê': {
            'r_crit_1': { id: 'r_crit_1', name: 'Í∏âÏÜå ÌååÏïÖ', description: level => `ÏπòÎ™ÖÌÉÄ ÌôïÎ•†Ïù¥ Î†àÎ≤®Îãπ 1%Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level}%)`, cost: level => 150 * (level + 1), prerequisites: [], effects: level => [{ stat: 'critChance', value: 0.01 * level }] },
            'r_evade_1': { id: 'r_evade_1', name: 'ÎÇ†Î†µÌïú Î™∏ÎÜÄÎ¶º', description: level => `ÌöåÌîº ÌôïÎ•†Ïù¥ Î†àÎ≤®Îãπ 1%Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level}%)`, cost: level => 150 * (level + 1), prerequisites: [], effects: level => [{ stat: 'evadeChance', value: 0.01 * level }] },
            'r_atk_1': { id: 'r_atk_1', name: 'Îã®Í≤Ä Ïó∞Îßà', description: level => `Í≥µÍ≤©Î†•Ïù¥ Î†àÎ≤®Îãπ 2Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level*2})`, cost: level => 120 * (level + 1), prerequisites: [{id: 'r_crit_1', level: 1}], effects: level => [{ stat: 'attackPower', value: 2 * level }] },
            'r_execute_1': { id: 'r_execute_1', name: 'ÎßàÎ¨¥Î¶¨ ÏùºÍ≤©', maxLevel: 1, description: level => `Ï≤¥Î†•Ïù¥ 25% Ïù¥ÌïòÏù∏ Ï†ÅÏóêÍ≤å 20%Ïùò Ï∂îÍ∞Ä ÌîºÌï¥Î•º ÏûÖÌûôÎãàÎã§.`, cost: level => 1000, prerequisites: [{id: 'r_atk_1', level: 2}], effects: level => [] },
            'r_ult_2': { id: 'r_ult_2', name: 'Ïó∞ÎßâÌÉÑ', maxLevel: 3, description: ULTIMATE_SKILLS_2['ÏïîÏÇ¥Ïûê'].description, cost: level => 2000 * (level + 1), prerequisites: [{id: 'r_execute_1', level: 1}], effects: level => [] },
            'r_ult_3': { id: 'r_ult_3', name: 'Ïã¨Ïû• Ï∞åÎ•¥Í∏∞', maxLevel: 3, description: ULTIMATE_SKILLS_3['ÏïîÏÇ¥Ïûê'].description, cost: level => 5000 * (level + 1), prerequisites: [{id: 'r_ult_2', level: 1}], effects: level => [] },
        },
        'Í∂ÅÏàò': {
            'a_atk_1': { id: 'a_atk_1', name: 'Î™ÖÍ∂ÅÏùò ÎßàÏùå', description: level => `Í≥µÍ≤©Î†•Ïù¥ Î†àÎ≤®Îãπ 2Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level*2})`, cost: level => 120 * (level + 1), prerequisites: [], effects: level => [{ stat: 'attackPower', value: 2 * level }] },
            'a_crit_1': { id: 'a_crit_1', name: 'Îß§Ïùò Îàà', description: level => `ÏπòÎ™ÖÌÉÄ ÌôïÎ•†Ïù¥ Î†àÎ≤®Îãπ 1%Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level}%)`, cost: level => 150 * (level + 1), prerequisites: [], effects: level => [{ stat: 'critChance', value: 0.01 * level }] },
            'a_crit_dmg_1': { id: 'a_crit_dmg_1', name: 'ÏïΩÏ†ê Í∞ÑÌåå', description: level => `ÏπòÎ™ÖÌÉÄ ÌîºÌï¥ÎüâÏù¥ Î†àÎ≤®Îãπ 5%Ïî© Ï¶ùÍ∞ÄÌï©ÎãàÎã§. (Ï¥ù +${level*5}%)`, cost: level => 200 * (level + 1), prerequisites: [{id: 'a_crit_1', level: 1}], effects: level => [{ stat: 'critDamage', value: 0.05 * level }] },
            'a_ult_1': { id: 'a_ult_1', name: 'ÏßëÏ§ë ÏÇ¨Í≤© Í∞ïÌôî', description: level => `ÏßëÏ§ë ÏÇ¨Í≤©Ïùò ÏπòÎ™ÖÌÉÄ ÌôïÎ•† Ï¶ùÍ∞Ä Ìö®Í≥ºÍ∞Ä Î†àÎ≤®Îãπ 2%Ïî© Ï∂îÍ∞ÄÎê©ÎãàÎã§.`, cost: level => 500 * (level + 1), prerequisites: [{id: 'a_crit_dmg_1', level: 2}], effects: level => [] },
            'a_ult_2': { id: 'a_ult_2', name: 'ÌôîÏÇ¥ÎπÑ', maxLevel: 3, description: ULTIMATE_SKILLS_2['Í∂ÅÏàò'].description, cost: level => 2000 * (level + 1), prerequisites: [{id: 'a_ult_1', level: 1}], effects: level => [] },
            'a_ult_3': { id: 'a_ult_3', name: 'Íø∞Îö´Îäî ÌôîÏÇ¥', maxLevel: 3, description: ULTIMATE_SKILLS_3['Í∂ÅÏàò'].description, cost: level => 5000 * (level + 1), prerequisites: [{id: 'a_ult_2', level: 1}], effects: level => [] },
        },
    };

    const ITEM_DATABASE = [
        // Common
        { id: 101, name: "ÎÖπÏä® Í≤Ä", type: 'weapon', stats: { attackPower: 2 }, rarity: 'common', cost: 25, classRestriction: ['Ï†ÑÏÇ¨'] },
        { id: 102, name: "Ìï¥ÏßÑ Î°úÎ∏å", type: 'armor', stats: { maxHp: 10 }, rarity: 'common', cost: 25, classRestriction: ['ÎßàÎ≤ïÏÇ¨'] },
        { id: 103, name: "Í∞ÄÏ£Ω Í∞ëÏò∑", type: 'armor', stats: { defense: 1, evadeChance: 0.01 }, rarity: 'common', cost: 25, classRestriction: ['ÏïîÏÇ¥Ïûê'] },
        { id: 104, name: "ÎÇòÎ¨¥ ÏßÄÌå°Ïù¥", type: 'weapon', stats: { attackPower: 3 }, rarity: 'common', cost: 25, classRestriction: ['ÎßàÎ≤ïÏÇ¨'] },
        { id: 105, name: "ÏûëÏùÄ Îã®Í≤Ä", type: 'weapon', stats: { attackPower: 1, critChance: 0.02 }, rarity: 'common', cost: 25, classRestriction: ['ÏïîÏÇ¥Ïûê'] },
        { id: 106, name: "ÌåêÍ∏à Ï°∞ÎÅº", type: 'armor', stats: { defense: 2 }, rarity: 'common', cost: 25, classRestriction: ['Ï†ÑÏÇ¨'] },
        { id: 107, name: "ÏßßÏùÄ Ìôú", type: 'weapon', stats: { attackPower: 2, critChance: 0.01 }, rarity: 'common', cost: 25, classRestriction: ['Í∂ÅÏàò'] },
        { id: 108, name: "ÏÇ¨ÎÉ•Íæº Ï°∞ÎÅº", type: 'armor', stats: { defense: 1, evadeChance: 0.02 }, rarity: 'common', cost: 25, classRestriction: ['Í∂ÅÏàò'] },

        // Uncommon
        { id: 201, name: "Í∞ïÏ≤† Í≤Ä", type: 'weapon', stats: { attackPower: 5 }, rarity: 'uncommon', cost: 100, classRestriction: ['Ï†ÑÏÇ¨'] },
        { id: 202, name: "ÎßàÎ≤ïÏÇ¨Ïùò Î°úÎ∏å", type: 'armor', stats: { maxHp: 20, attackPower: 2 }, rarity: 'uncommon', cost: 100, classRestriction: ['ÎßàÎ≤ïÏÇ¨'] },
        { id: 203, name: "Í∑∏Î¶ºÏûê ÏÇ¨Ïä¨ Í∞ëÏò∑", type: 'armor', stats: { defense: 2, maxHp: 10, evadeChance: 0.03 }, rarity: 'uncommon', cost: 100, classRestriction: ['ÏïîÏÇ¥Ïûê'] },
        { id: 204, name: "Î≥¥ÏÑù Î∞ïÌûå ÏßÄÌå°Ïù¥", type: 'weapon', stats: { attackPower: 6 }, rarity: 'uncommon', cost: 100, classRestriction: ['ÎßàÎ≤ïÏÇ¨'] },
        { id: 205, name: "ÏïîÏÇ¥ÏûêÏùò Îã®Í≤Ä", type: 'weapon', stats: { attackPower: 3, critChance: 0.05 }, rarity: 'uncommon', cost: 100, classRestriction: ['ÏïîÏÇ¥Ïûê'] },
        { id: 206, name: "Í∞ïÏ≤† Í∞ëÏò∑", type: 'armor', stats: { defense: 4, maxHp: 25 }, rarity: 'uncommon', cost: 100, classRestriction: ['Ï†ÑÏÇ¨'] },
        { id: 207, name: "Ïû•Í∂Å", type: 'weapon', stats: { attackPower: 5, critChance: 0.02 }, rarity: 'uncommon', cost: 100, classRestriction: ['Í∂ÅÏàò'] },
        { id: 208, name: "Ï†ïÏ∞∞Î≥ëÏùò Í∞ëÏò∑", type: 'armor', stats: { defense: 2, evadeChance: 0.03, maxHp: 15 }, rarity: 'uncommon', cost: 100, classRestriction: ['Í∂ÅÏàò'] },
        
        // Rare
        { id: 301, name: "Î£¨ Î∏îÎ†àÏù¥Îìú", type: 'weapon', stats: { attackPower: 8, critChance: 0.03 }, rarity: 'rare', cost: 300, classRestriction: ['Ï†ÑÏÇ¨'] },
        { id: 302, name: "ÎåÄÎßàÎ≤ïÏÇ¨Ïùò Î°úÎ∏å", type: 'armor', stats: { maxHp: 30, attackPower: 5, defense: 1 }, rarity: 'rare', cost: 300, classRestriction: ['ÎßàÎ≤ïÏÇ¨'] },
        { id: 303, name: "Í∏∞ÏÇ¨Ïùò Í∞ëÏò∑", type: 'armor', stats: { defense: 5, maxHp: 40 }, rarity: 'rare', cost: 300, classRestriction: ['Ï†ÑÏÇ¨'] },
        { id: 304, name: "ÌòÑÏûêÏùò ÏßÄÌå°Ïù¥", type: 'weapon', stats: { attackPower: 10, maxHp: 20 }, rarity: 'rare', cost: 300, classRestriction: ['ÎßàÎ≤ïÏÇ¨'] },
        { id: 305, name: "ÎèÖÏÇ¨Ïùò ÏÜ°Í≥≥Îãà", type: 'weapon', stats: { attackPower: 7, critChance: 0.07 }, rarity: 'rare', cost: 300, classRestriction: ['ÏïîÏÇ¥Ïûê'] },
        { id: 306, name: "Î∞§Ïùò Ïû•Îßâ Í∞ëÏò∑", type: 'armor', stats: { defense: 3, evadeChance: 0.05, maxHp: 20 }, rarity: 'rare', cost: 300, classRestriction: ['ÏïîÏÇ¥Ïûê'] },
        { id: 307, name: "ÏÇ¨ÎÉ•ÍæºÏùò Ìôú", type: 'weapon', stats: { attackPower: 8, critChance: 0.05 }, rarity: 'rare', cost: 300, classRestriction: ['Í∂ÅÏàò'] },
        { id: 308, name: "Î∞îÎûåÏùò Í∞ÄÏ£Ω Í∞ëÏò∑", type: 'armor', stats: { defense: 4, evadeChance: 0.04, critChance: 0.02 }, rarity: 'rare', cost: 300, classRestriction: ['Í∂ÅÏàò'] },
        
        // Legendary
        { id: 401, name: "Ïö©ÏÇ¥ÏûêÏùò ÎåÄÍ≤Ä", type: 'weapon', stats: { attackPower: 20, maxHp: 50 }, rarity: 'legendary', cost: 5000, classRestriction: ['Ï†ÑÏÇ¨'] },
        { id: 402, name: "ÏïÑÌÅ¨Î©îÏù¥ÏßÄÏùò ÏßÄÌå°Ïù¥", type: 'weapon', stats: { attackPower: 25 }, rarity: 'legendary', cost: 5000, classRestriction: ['ÎßàÎ≤ïÏÇ¨'] },
        { id: 403, name: "ÏõîÍ¥ëÏùò Îã®Í≤Ä", type: 'weapon', stats: { attackPower: 15, critChance: 0.10, evadeChance: 0.05 }, rarity: 'legendary', cost: 5000, classRestriction: ['ÏïîÏÇ¥Ïûê'] },
        { id: 404, name: "ÏàòÌò∏Ïã†Ïùò Í∞ëÏ£º", type: 'armor', stats: { defense: 10, maxHp: 100 }, rarity: 'legendary', cost: 5000, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'] },
        { id: 405, name: "Ìè≠ÌíçÏùò Ìôú", type: 'weapon', stats: { attackPower: 18, critChance: 0.08 }, rarity: 'legendary', cost: 5000, classRestriction: ['Í∂ÅÏàò'] },

        // Mythic
        { id: 601, name: "Ï≤úÎ≤å", type: 'weapon', stats: { attackPower: 35, critChance: 0.10 }, rarity: 'mythic', cost: 99999, classRestriction: ['Ï†ÑÏÇ¨'], isGachaOnly: true },
        { id: 602, name: "Ï¢ÖÎßêÏùò ÏÑú", type: 'weapon', stats: { attackPower: 40, maxHp: 50 }, rarity: 'mythic', cost: 99999, classRestriction: ['ÎßàÎ≤ïÏÇ¨'], isGachaOnly: true },
        { id: 603, name: "Î∞§Ïùò ÌååÌé∏", type: 'weapon', stats: { attackPower: 25, critChance: 0.15, evadeChance: 0.08 }, rarity: 'mythic', cost: 99999, classRestriction: ['ÏïîÏÇ¥Ïûê'], isGachaOnly: true },
        { id: 604, name: "ÏÑ∏Í≥ÑÏàòÏùò Ïã¨Ïû•", type: 'armor', stats: { defense: 15, maxHp: 150, evadeChance: 0.05 }, rarity: 'mythic', cost: 99999, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'], isGachaOnly: true },
        { id: 605, name: "Ï≤úÍ≥µÏùò Î∂ÑÎÖ∏", type: 'weapon', stats: { attackPower: 30, critChance: 0.15 }, rarity: 'mythic', cost: 99999, classRestriction: ['Í∂ÅÏàò'], isGachaOnly: true },

        // Ultimate
        { id: 701, name: "Í∂ÅÍ∑πÏùò ÌååÎ©∏Í≤Ä", type: 'weapon', stats: { attackPower: 50, critDamage: 0.15 }, rarity: 'ultimate', cost: 999999, classRestriction: ['Ï†ÑÏÇ¨'], isGachaOnly: true },
        { id: 702, name: "ÌÉúÏ¥àÏùò ÏßÄÌòú", type: 'weapon', stats: { attackPower: 60, maxHp: 100 }, rarity: 'ultimate', cost: 999999, classRestriction: ['ÎßàÎ≤ïÏÇ¨'], isGachaOnly: true },
        { id: 703, name: "ÏãúÍ∞Ñ ÏôúÍ≥° Îã®Í≤Ä", type: 'weapon', stats: { attackPower: 35, critChance: 0.1, evadeChance: 0.1 }, rarity: 'ultimate', cost: 999999, classRestriction: ['ÏïîÏÇ¥Ïûê'], isGachaOnly: true },
        { id: 704, name: "Î≥ÑÏùò ÎÖ∏Îûò", type: 'weapon', stats: { attackPower: 45, critChance: 0.20 }, rarity: 'ultimate', cost: 999999, classRestriction: ['Í∂ÅÏàò'], isGachaOnly: true },
        { id: 705, name: "Ï∞ΩÏ°∞Ïã†Ïùò Í∞ëÏ£º", type: 'armor', stats: { defense: 25, maxHp: 250, evadeChance: 0.05 }, rarity: 'ultimate', cost: 999999, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'], isGachaOnly: true },

        // Eternal
        { id: 805, name: "ÏòÅÏõêÏùò ÏÑ±Ïùò", type: 'armor', stats: { defense: 40, maxHp: 400, evadeChance: 0.08 }, rarity: 'eternal', cost: 9999999, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'], isGachaOnly: true },

        // Accessories
        { id: 501, name: "ÌûòÏùò Î∞òÏßÄ", type: 'accessory', stats: { attackPower: 5 }, rarity: 'rare', cost: 300, classRestriction: ['Ï†ÑÏÇ¨', 'ÎßàÎ≤ïÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'Í∂ÅÏàò'] },
        { id: 502, name: "ÌôúÎ†•Ïùò Î∂ÄÏ†Å", type: 'accessory', stats: { maxHp: 50 }, rarity: 'rare', cost: 300, classRestriction: ['Ï†ÑÏÇ¨', 'ÎßàÎ≤ïÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'Í∂ÅÏàò'] },
        { id: 503, "name": "ÏàòÌò∏Ïùò ÏßïÌëú", type: 'accessory', stats: { defense: 5 }, rarity: 'rare', cost: 300, classRestriction: ['Ï†ÑÏÇ¨', 'ÎßàÎ≤ïÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'Í∂ÅÏàò'] },
        { id: 504, "name": "ÌïÑÏÇ¥Ïùò Î∞òÏßÄ", type: 'accessory', stats: { critChance: 0.05 }, rarity: 'legendary', cost: 5000, classRestriction: ['Ï†ÑÏÇ¨', 'ÎßàÎ≤ïÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'Í∂ÅÏàò'] },
        { id: 505, "name": "Í∑∏Î¶ºÏûê ÎßùÌÜ†", type: 'accessory', stats: { evadeChance: 0.05 }, rarity: 'legendary', cost: 5000, classRestriction: ['Ï†ÑÏÇ¨', 'ÎßàÎ≤ïÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'Í∂ÅÏàò'] },
        { id: 506, "name": "ÌòÑÏûêÏùò Îèå", type: 'accessory', stats: { attackPower: 8, maxHp: 80 }, rarity: 'legendary', cost: 5000, classRestriction: ['Ï†ÑÏÇ¨', 'ÎßàÎ≤ïÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'Í∂ÅÏàò'] },
        { id: 507, name: "ÌÉÄÏù¥ÌÉÑÏùò Í≤¨Í∞ë", type: 'accessory', rarity: 'mythic', cost: 99999, stats: { maxHp: 120, defense: 10, attackPower: 10 }, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'] },
        { id: 508, name: "Ïã†ÏÜçÏùò Í∞ÅÎ∞ò", type: 'accessory', rarity: 'mythic', cost: 99999, stats: { evadeChance: 0.08, critChance: 0.08 }, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'] },
        { id: 509, name: "Ï†ÑÎä•Ïùò Îàà", type: 'accessory', rarity: 'ultimate', cost: 999999, stats: { attackPower: 20, critChance: 0.1, critDamage: 0.1 }, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'], isGachaOnly: true },
        { id: 510, name: "Î∂àÎ©∏ÏûêÏùò Ïã¨Ïû•", type: 'accessory', rarity: 'ultimate', cost: 999999, stats: { maxHp: 300, defense: 20 }, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'], isGachaOnly: true },

        // Relics
        { id: 901, name: "ÌîºÏùò ÏÑ±Î∞∞", type: 'relic', rarity: 'legendary', cost: 7500, stats: { maxHp: 100, attackPower: 10 }, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'] },
        { id: 902, name: "Ìè≠ÌíçÏùò Îàà", type: 'relic', rarity: 'mythic', cost: 99999, stats: { critChance: 0.06, evadeChance: 0.06 }, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'], isGachaOnly: true },
        { id: 903, name: "Í≥†ÎåÄ Ïã†Ïùò Ï°∞Í∞ÅÏÉÅ", type: 'relic', rarity: 'ultimate', cost: 999999, stats: { allStatsPercent: 0.05 }, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'], isGachaOnly: true },
        { id: 904, name: "Ï∞ΩÏ°∞Ïùò Í∑ºÏõê", type: 'relic', rarity: 'eternal', cost: 9999999, stats: { attackPower: 25, defense: 25, maxHp: 250 }, classRestriction: ['Ï†ÑÏÇ¨', 'ÏïîÏÇ¥Ïûê', 'ÎßàÎ≤ïÏÇ¨', 'Í∂ÅÏàò'], isGachaOnly: true },
    ];
    
    const ENCHANTMENT_POOL = {
        weapon: {
            common: [ { id: 'w_c_atk', description: 'Í≥µÍ≤©Î†• +3', effects: { attackPower: 3 } }, { id: 'w_c_crit', description: 'ÏπòÎ™ÖÌÉÄ +1%', effects: { critChance: 0.01 } } ],
            uncommon: [ { id: 'w_u_atk', description: 'Í≥µÍ≤©Î†• +6', effects: { attackPower: 6 } }, { id: 'w_u_crit', description: 'ÏπòÎ™ÖÌÉÄ +2%', effects: { critChance: 0.02 } } ],
            rare: [ { id: 'w_r_atk', description: 'Í≥µÍ≤©Î†• +10', effects: { attackPower: 10 } }, { id: 'w_r_crit', description: 'ÏπòÎ™ÖÌÉÄ +4%', effects: { critChance: 0.04 } } ],
            legendary: [ { id: 'w_l_atk', description: 'Í≥µÍ≤©Î†• +25', effects: { attackPower: 25 } }, { id: 'w_l_crit', description: 'ÏπòÎ™ÖÌÉÄ +8%', effects: { critChance: 0.08 } }, { id: 'w_l_all', description: 'Í≥µÍ≤©Î†• +10, ÏπòÎ™ÖÌÉÄ +3%', effects: { attackPower: 10, critChance: 0.03 } } ],
            mythic: [ { id: 'w_m_atk', description: 'Í≥µÍ≤©Î†• +40', effects: { attackPower: 40 } }, { id: 'w_m_crit', description: 'ÏπòÎ™ÖÌÉÄ +12%', effects: { critChance: 0.12 } }, { id: 'w_m_all', description: 'Î™®Îì† Îä•Î†•Ïπò +5%', effects: { attackPowerPercent: 0.05, maxHpPercent: 0.05, defensePercent: 0.05 } } ],
            ultimate: [ { id: 'w_u_atk', description: 'Í≥µÍ≤©Î†• +60', effects: { attackPower: 60 } }, { id: 'w_u_crit_dmg', description: 'ÏπòÎ™ÖÌÉÄÌîºÌï¥ +15%', effects: { critDamage: 0.15 } } ],
            eternal: [ { id: 'w_e_atk', description: 'Í≥µÍ≤©Î†• +100', effects: { attackPower: 100 } }, { id: 'w_e_all', description: 'Î™®Îì† Îä•Î†•Ïπò +10%', effects: { attackPowerPercent: 0.1, maxHpPercent: 0.1, defensePercent: 0.1 } } ],
        },
        armor: {
            common: [ { id: 'a_c_hp', description: 'ÏµúÎåÄ HP +15', effects: { maxHp: 15 } }, { id: 'a_c_def', description: 'Î∞©Ïñ¥Î†• +2', effects: { defense: 2 } } ],
            uncommon: [ { id: 'a_u_hp', description: 'ÏµúÎåÄ HP +30', effects: { maxHp: 30 } }, { id: 'a_u_def', description: 'Î∞©Ïñ¥Î†• +4', effects: { defense: 4 } }, { id: 'a_u_evade', description: 'ÌöåÌîº +1%', effects: { evadeChance: 0.01 } } ],
            rare: [ { id: 'a_r_hp', description: 'ÏµúÎåÄ HP +50', effects: { maxHp: 50 } }, { id: 'a_r_def', description: 'Î∞©Ïñ¥Î†• +7', effects: { defense: 7 } }, { id: 'a_r_evade', description: 'ÌöåÌîº +2%', effects: { evadeChance: 0.02 } } ],
            legendary: [ { id: 'a_l_hp', description: 'ÏµúÎåÄ HP +120', effects: { maxHp: 120 } }, { id: 'a_l_def', description: 'Î∞©Ïñ¥Î†• +15', effects: { defense: 15 } }, { id: 'a_l_evade', description: 'ÌöåÌîº +5%', effects: { evadeChance: 0.05 } } ],
            mythic: [ { id: 'a_m_hp', description: 'ÏµúÎåÄ HP +200', effects: { maxHp: 200 } }, { id: 'a_m_def', description: 'Î∞©Ïñ¥Î†• +25', effects: { defense: 25 } }, { id: 'a_m_all', description: 'ÌöåÌîº +5%, Î∞©Ïñ¥Î†• +15', effects: { evadeChance: 0.05, defense: 15 } } ],
            ultimate: [ { id: 'a_u_hp', description: 'ÏµúÎåÄ HP +300', effects: { maxHp: 300 } }, { id: 'a_u_def', description: 'Î∞©Ïñ¥Î†• +40', effects: { defense: 40 } } ],
            eternal: [ { id: 'a_e_hp_def', description: 'ÏµúÎåÄ HP +500, Î∞©Ïñ¥Î†• +50', effects: { maxHp: 500, defense: 50 } }, { id: 'a_e_evade_hp', description: 'ÌöåÌîº +10%, ÏµúÎåÄ HP +250', effects: { evadeChance: 0.1, maxHp: 250 } } ],
        },
        accessory: {
            rare: [ { id: 'ac_r_atk', description: 'Í≥µÍ≤©Î†• +8', effects: { attackPower: 8 } }, { id: 'ac_r_hp', description: 'ÏµúÎåÄ HP +40', effects: { maxHp: 40 } } ],
            legendary: [ { id: 'ac_l_crit', description: 'ÏπòÎ™ÖÌÉÄ +3%', effects: { critChance: 0.03 } }, { id: 'ac_l_evade', description: 'ÌöåÌîº +3%', effects: { evadeChance: 0.03 } }, { id: 'ac_l_all', description: 'Í≥µÍ≤©Î†• +5, Î∞©Ïñ¥Î†• +5', effects: { attackPower: 5, defense: 5 } } ],
            mythic: [ { id: 'ac_m_all_stats', description: 'Î™®Îì† Îä•Î†•Ïπò +10', effects: { attackPower: 10, defense: 10, maxHp: 50 }}, { id: 'ac_m_crit_evade', description: 'ÏπòÎ™ÖÌÉÄ +5%, ÌöåÌîº +5%', effects: { critChance: 0.05, evadeChance: 0.05 }}],
            ultimate: [ { id: 'ac_u_all_stats', description: 'Î™®Îì† Îä•Î†•Ïπò +20', effects: { attackPower: 20, defense: 20, maxHp: 100 }}, { id: 'ac_u_crit_dmg', description: 'ÏπòÎ™ÖÌÉÄÌîºÌï¥ +10%', effects: { critDamage: 0.1 }} ],
        },
        relic: {
            legendary: [ { id: 're_l_atk', description: 'Í≥µÍ≤©Î†• +15', effects: { attackPower: 15 } }, { id: 're_l_hp', description: 'ÏµúÎåÄ HP +120', effects: { maxHp: 120 } } ],
            mythic: [ { id: 're_m_crit_evade', description: 'ÏπòÎ™ÖÌÉÄ +4%, ÌöåÌîº +4%', effects: { critChance: 0.04, evadeChance: 0.04 } }, { id: 're_m_def_hp', description: 'Î∞©Ïñ¥Î†• +15, ÏµúÎåÄ HP +100', effects: { defense: 15, maxHp: 100 } } ],
            ultimate: [ { id: 're_u_all_percent', description: 'Î™®Îì† Îä•Î†•Ïπò +3%', effects: { allStatsPercent: 0.03 } }, { id: 're_u_crit_dmg', description: 'ÏπòÎ™ÖÌÉÄÌîºÌï¥ +12%', effects: { critDamage: 0.12 } } ],
            eternal: [ { id: 're_e_all_flat', description: 'Í≥µÍ≤©Î†• +20, Î∞©Ïñ¥Î†• +20, ÏµúÎåÄ HP +200', effects: { attackPower: 20, defense: 20, maxHp: 200 } }, { id: 're_e_all_percent', description: 'Î™®Îì† Îä•Î†•Ïπò +5%', effects: { allStatsPercent: 0.05 } } ],
        }
    };

    const QUEST_POOL = [
        { type: 'KILL_MONSTERS', description: (n) => `Î™¨Ïä§ÌÑ∞ ${n}ÎßàÎ¶¨ Ï≤òÏπò`, targets: [10, 15, 20], reward: { gold: 150, stones: 3 } },
        { type: 'CLEAR_DUNGEON', description: (n) => `ÎçòÏ†Ñ ${n}Ìöå ÌÅ¥Î¶¨Ïñ¥`, targets: [1, 2], reward: { gold: 250, potions: 1 } },
        { type: 'ENHANCE_ATTEMPTS', description: (n) => `Ïû•ÎπÑ Í∞ïÌôî ${n}Ìöå ÏãúÎèÑ`, targets: [3, 5], reward: { gold: 200, stones: 5 } },
        { type: 'USE_ULTIMATE', description: (n) => `ÌäπÏàò Í∏∞Ïà† ${n}Ìöå ÏÇ¨Ïö©`, targets: [5, 8], reward: { gold: 100, potions: 1 } },
        { type: 'EARN_GOLD', description: (n) => `Í≥®Îìú ${n} ÌöçÎìù`, targets: [500, 1000], reward: { gold: 100, stones: 2 } },
    ];
    
    const PERMANENT_QUESTS_DATA = [
      { id: 'reach_level_10', type: 'REACH_LEVEL', description: 'Î†àÎ≤® 10 Îã¨ÏÑ±', target: 10, reward: { gold: 1000, stones: 10 } },
      { id: 'reach_level_20', type: 'REACH_LEVEL', description: 'Î†àÎ≤® 20 Îã¨ÏÑ±', target: 20, reward: { gold: 5000, stones: 25 } },
      { id: 'reach_level_30', type: 'REACH_LEVEL', description: 'Î†àÎ≤® 30 Îã¨ÏÑ±', target: 30, reward: { gold: 10000, dust: 50 } },
      { id: 'reach_level_50', type: 'REACH_LEVEL', description: 'Î†àÎ≤® 50 Îã¨ÏÑ±', target: 50, reward: { gold: 50000, stones: 100 } },
      { id: 'defeat_dragon', type: 'DEFEAT_BOSS', description: 'ÎìúÎûòÍ≥§ Ï≤òÏπò', targetName: 'ÎìúÎûòÍ≥§', target: 1, reward: { gold: 3000, potions: 5 } },
      { id: 'enhance_10', type: 'ENHANCE_SUCCESS', description: 'Ïû•ÎπÑ +10Í∞ï ÏÑ±Í≥µ', target: 10, reward: { gold: 2000, dust: 100 } },
      { id: 'enhance_15', type: 'ENHANCE_SUCCESS', description: 'Ïû•ÎπÑ +15Í∞ï ÏÑ±Í≥µ', target: 15, reward: { gold: 20000, stones: 150 } },
      { id: 'collect_gold_50k', type: 'COLLECT_GOLD', description: 'Ï¥ù 50,000Í≥®Îìú ÏàòÏßë', target: 50000, reward: { stones: 20, potions: 3 } },
      { id: 'collect_gold_250k', type: 'COLLECT_GOLD', description: 'Ï¥ù 250,000Í≥®Îìú ÏàòÏßë', target: 250000, reward: { gold: 10000, dust: 200 } },
      { id: 'first_rebirth', type: 'REBIRTH', description: 'Ï≤´ ÌôòÏÉù Îã¨ÏÑ±', target: 1, reward: { stones: 50, dust: 250 } },
      { id: 'rebirth_3', type: 'REBIRTH', description: '3Ìöå ÌôòÏÉù Îã¨ÏÑ±', target: 3, reward: { gold: 30000, stones: 100 } },
      { id: 'rebirth_5', type: 'REBIRTH', description: '5Ìöå ÌôòÏÉù Îã¨ÏÑ±', target: 5, reward: { gold: 100000, dust: 500 } },
      { id: 'transcend_1', type: 'TRANSCEND', description: 'Ï≤´ Ï¥àÏõî ÏÑ±Í≥µ', target: 1, reward: { gold: 5000, stones: 20 } },
      { id: 'transcend_5', type: 'TRANSCEND', description: 'Ï¥àÏõî 5Îã®Í≥Ñ Ïû•ÎπÑ Ï†úÏûë', target: 5, reward: { gold: 50000, dust: 300 } },
      { id: 'liberation', type: 'LIBERATION', description: 'Ìï¥Î∞© Îã¨ÏÑ±', target: 1, reward: { gold: 100000, stones: 200, dust: 500 } },
    ];
    
    const REBIRTH_UPGRADES = {
        'gold_gain': { name: 'Í≥®Îìú ÌöçÎìùÎüâ Ï¶ùÍ∞Ä', description: level => `Í≥®Îìú ÌöçÎìùÎüâÏù¥ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ${level * 5}% Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`, cost: level => (level + 1) },
        'xp_gain': { name: 'Í≤ΩÌóòÏπò ÌöçÎìùÎüâ Ï¶ùÍ∞Ä', description: level => `Í≤ΩÌóòÏπò ÌöçÎìùÎüâÏù¥ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ${level * 5}% Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`, cost: level => (level + 1) },
        'base_atk': { name: 'Í∏∞Î≥∏ Í≥µÍ≤©Î†• Ï¶ùÍ∞Ä', description: level => `Î™®Îì† ÏßÅÏóÖÏùò Í∏∞Î≥∏ Í≥µÍ≤©Î†•Ïù¥ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ${level * 2} Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`, cost: level => (level + 1) * 2 },
        'base_hp': { name: 'Í∏∞Î≥∏ ÏÉùÎ™ÖÎ†• Ï¶ùÍ∞Ä', description: level => `Î™®Îì† ÏßÅÏóÖÏùò Í∏∞Î≥∏ ÏÉùÎ™ÖÎ†•Ïù¥ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ${level * 10} Ï¶ùÍ∞ÄÌï©ÎãàÎã§.`, cost: level => (level + 1) * 2 },
        'ultimate_cooldown': { name: 'Í∂ÅÍ∑πÏùò Í∏∞Ïà† Ïó∞Îßà', maxLevel: 4, description: level => `Í∂ÅÍ∑πÍ∏∞ Ïû¨ÏÇ¨Ïö© ÎåÄÍ∏∞ÏãúÍ∞ÑÏù¥ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ${level * 5}% Í∞êÏÜåÌï©ÎãàÎã§. (ÌòÑÏû¨: -${level*5}%)`, cost: level => (level + 1) * 3 }
    };


    let player;
    let monster;
    let messageLog;
    let currentScreen;
    let currentDifficulty;
    let dungeonLevel;
    let dungeonFloor;
    let dailyQuests = [];
    let lastQuestDate = '';
    let shopFilterType = 'all';
    let shopFilterRarity = 'all';
    let blacksmithMode = 'enhance';
    let synthesisSelection = [null, null]; // { item, inventoryIndex }
    let batchDisenchantFilters = { common: false, uncommon: false, rare: false };
    let questScreenMode = 'daily';
    let guideElementsRendered = false;
    
    let survivalWave = 0;


    const monsterList = [
        { name: 'Ïä¨ÎùºÏûÑ', emoji: 'üíß', baseHp: 20, baseAttack: 5, xp: 25, gold: 5, lootTable: [102, 105] },
        { name: 'Í≥†Î∏îÎ¶∞', emoji: 'üë∫', baseHp: 30, baseAttack: 7, xp: 40, gold: 10, lootTable: [101, 103, 105, 107, 108], onHitEffect: {type: 'weaken', chance: 0.2, duration: 2, potency: 0.1} },
        { name: 'Ïò§ÌÅ¨', emoji: 'üëπ', baseHp: 45, baseAttack: 11, xp: 60, gold: 15, lootTable: [101, 106, 201] },
        { name: 'ÎèÖÍ±∞ÎØ∏', emoji: 'üï∑Ô∏è', baseHp: 55, baseAttack: 12, xp: 75, gold: 20, lootTable: [205, 203, 207, 208], onHitEffect: {type: 'poison', chance: 0.4, duration: 3, potency: 4} },
        { name: 'Ïä§ÏºàÎ†àÌÜ§', emoji: 'üíÄ', baseHp: 65, baseAttack: 14, xp: 85, gold: 25, lootTable: [201, 206] },
    ];

    const bossList = [
        { name: 'ÎèôÍµ¥ Ìä∏Î°§', emoji: 'üóø', baseHp: 100, baseAttack: 18, xp: 200, gold: 100, lootTable: [201, 206, 205], onHitEffect: {type: 'stun', chance: 0.2, duration: 1, potency: 0} },
        { name: 'Í±∞ÎåÄ Í≥®Î†ò', emoji: 'ü§ñ', baseHp: 150, baseAttack: 23, xp: 300, gold: 150, lootTable: [202, 204, 303], onHitEffect: {type: 'vulnerable', chance: 0.5, duration: 2, potency: 0.25} },
        { name: 'ÌùëÍ∏∞ÏÇ¨', emoji: '‚ôû', baseHp: 200, baseAttack: 28, xp: 450, gold: 220, lootTable: [301, 303, 307, 308], onHitEffect: {type: 'weaken', chance: 0.4, duration: 3, potency: 0.2} },
        { name: 'ÎìúÎûòÍ≥§', emoji: 'üê≤', baseHp: 270, baseAttack: 34, xp: 600, gold: 300, lootTable: [301, 302], onHitEffect: {type: 'burn', chance: 0.7, duration: 3, potency: 15} },
    ];
    
    // --- Helper Functions ---
    function isInventoryFull() {
        return player.inventory.length >= INVENTORY_LIMIT;
    }

    function canAddItem(count = 1) {
        return player.inventory.length + count <= INVENTORY_LIMIT;
    }

    function removeGuideElements() {
        document.getElementById('guide-button')?.remove();
        document.getElementById('guide-modal')?.remove();
        guideElementsRendered = false;
    }

    function removePermanentUI() {
        document.getElementById('game-reset-button')?.remove();
        document.getElementById('rank-display')?.remove();
    }

    function getPlayerRank() {
        if (!player) return { rank: 'C', colorClass: 'rank-C' };
        if (player.rebirths >= 3 && player.isLiberated) return { rank: 'SSS', colorClass: 'rank-SSS' };
        if (player.rebirths >= 3) return { rank: 'SS', colorClass: 'rank-SS' };
        if (player.rebirths >= 2) return { rank: 'S', colorClass: 'rank-S' };
        if (player.rebirths >= 1) return { rank: 'A', colorClass: 'rank-A' };
        if (player.level >= 15) return { rank: 'B', colorClass: 'rank-B' };
        return { rank: 'C', colorClass: 'rank-C' };
    }

    function renderPermanentUI() {
        let resetButton = document.getElementById('game-reset-button');
        if (!resetButton) {
            resetButton = document.createElement('button');
            resetButton.id = 'game-reset-button';
            resetButton.textContent = 'Í≤åÏûÑ Ï¥àÍ∏∞Ìôî';
            document.body.appendChild(resetButton);
            resetButton.addEventListener('click', () => {
                if (confirm('Ï†ïÎßêÎ°ú Í≤åÏûÑÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? Î™®Îì† ÏßÑÌñâ ÏÉÅÌô©Ïù¥ ÏÇ≠Ï†úÎêòÍ≥† ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                    removePermanentUI();
                    deleteSaveData(false);
                    createStartScreen();
                }
            });
        }

        let rankDisplay = document.getElementById('rank-display');
        if (!rankDisplay) {
            rankDisplay = document.createElement('div');
            rankDisplay.id = 'rank-display';
            document.body.appendChild(rankDisplay);
        }
        
        const { rank, colorClass } = getPlayerRank();
        rankDisplay.innerHTML = `
            <span>RANK</span>
            <span class="${colorClass}">${rank}</span>
        `;
    }

    function renderGuideElements() {
        if (guideElementsRendered) return;

        const guideButton = document.createElement('button');
        guideButton.id = 'guide-button';
        guideButton.textContent = '‚ùì';
        guideButton.title = 'Ï¥àÎ≥¥Ïûê Í∞ÄÏù¥Îìú';

        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'guide-modal';
        modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `
            <div class="modal-content">
                <h2>Ï¥àÎ≥¥Ïûê Í∞ÄÏù¥Îìú</h2>
                <div class="modal-body">
                    <h3>Í≤åÏûÑ Î™©Ìëú</h3>
                    <p>ÎçòÏ†ÑÏóê ÏûÖÏû•ÌïòÏó¨ Î™¨Ïä§ÌÑ∞Î•º Ï≤òÏπòÌïòÍ≥†, Îçî Ï¢ãÏùÄ Ïû•ÎπÑÎ•º ÌöçÎìùÌïòÏó¨ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ±Ïû•ÏãúÌÇ§ÏÑ∏Ïöî. ÏµúÏ¢Ö Î™©ÌëúÎäî Îçî ÎÜíÏùÄ Î†àÎ≤®Ïùò ÎçòÏ†ÑÏùÑ ÌÅ¥Î¶¨Ïñ¥ÌïòÍ≥†, ÌôòÏÉùÏùÑ ÌÜµÌï¥ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Í∞ïÌï¥ÏßÄÎäî Í≤ÉÏûÖÎãàÎã§.</p>
                    
                    <h3>Ï†ÑÌà¨</h3>
                    <ul>
                        <li><strong>Í≥µÍ≤©:</strong> Í∏∞Î≥∏ Í≥µÍ≤©ÏúºÎ°ú Î™¨Ïä§ÌÑ∞ÏóêÍ≤å ÌîºÌï¥Î•º Ï§çÎãàÎã§.</li>
                        <li><strong>Î¨ºÏïΩ:</strong> Ï≤¥Î†•ÏùÑ ÌöåÎ≥µÌï©ÎãàÎã§. ÏÉÅÏ†êÏóêÏÑú Íµ¨Îß§Ìï† Ïàò ÏûàÏäµÎãàÎã§.</li>
                        <li><strong>ÌäπÏàò Í∏∞Ïà†:</strong> ÏßÅÏóÖÎßàÎã§ Í≥†Ïú†Ïùò Í∞ïÎ†•Ìïú Í∏∞Ïà†ÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§. ÏÇ¨Ïö© ÌõÑÏóêÎäî Ïû¨ÏÇ¨Ïö© ÎåÄÍ∏∞ÏãúÍ∞ÑÏù¥ ÏûàÏäµÎãàÎã§.</li>
                        <li><strong>ÏÉÅÌÉú Ïù¥ÏÉÅ:</strong> ÎèÖ, ÌôîÏÉÅ, Í∏∞Ï†à Îì± Îã§ÏñëÌïú Ìö®Í≥ºÍ∞Ä Ï†ÑÌà¨Ïóê ÏòÅÌñ•ÏùÑ Ï§çÎãàÎã§. Î™¨Ïä§ÌÑ∞ÏôÄ ÌîåÎ†àÏù¥Ïñ¥ Î™®ÎëêÏóêÍ≤å Ï†ÅÏö©Îê† Ïàò ÏûàÏäµÎãàÎã§.</li>
                    </ul>

                    <h3>ÏÑ±Ïû•Í≥º Ïû•ÎπÑ</h3>
                    <ul>
                        <li><strong>Î†àÎ≤®ÏóÖ:</strong> Î™¨Ïä§ÌÑ∞Î•º Ï≤òÏπòÌïòÏó¨ Í≤ΩÌóòÏπò(XP)Î•º ÏñªÍ≥† Î†àÎ≤®ÏùÑ Ïò¨Î¶ΩÎãàÎã§.</li>
                        <li><strong>Ïû•ÎπÑ Îì±Í∏â:</strong> ÏùºÎ∞ò(Ìù∞ÏÉâ) &lt; Í≥†Í∏â(Ï¥àÎ°ùÏÉâ) &lt; Ìù¨Í∑Ä(ÌååÎûÄÏÉâ) &lt; Ï†ÑÏÑ§(Ï£ºÌô©ÏÉâ) &lt; Ïã†Ìôî(Îπ®Í∞ÑÏÉâ) &lt; Í∂ÅÍ∑π(Ï≤≠Î°ùÏÉâ) &lt; ÏòÅÏõê(Î∂ÑÌôçÏÉâ) ÏàúÏúºÎ°ú Í∞ïÎ†•Ìï©ÎãàÎã§.</li>
                        <li><strong>Ïû•ÎπÑ Í¥ÄÎ¶¨:</strong> 'Ïû•ÎπÑ' Î©îÎâ¥ÏóêÏÑú ÏïÑÏù¥ÌÖúÏùÑ Ïû•Ï∞©ÌïòÍ±∞ÎÇò Ïû†Í∏Ä Ïàò ÏûàÏäµÎãàÎã§. Ïû†Í∏¥ ÏïÑÏù¥ÌÖúÏùÄ Î∂ÑÌï¥Í∞Ä Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§. <strong>Ïù∏Î≤§ÌÜ†Î¶¨Îäî ${INVENTORY_LIMIT}Ïπ∏ÏúºÎ°ú Ï†úÌïúÎê©ÎãàÎã§.</strong></li>
                    </ul>

                    <h3>ÎåÄÏû•Í∞Ñ</h3>
                    <ul>
                        <li><strong>Í∞ïÌôî:</strong> Í≥®ÎìúÏôÄ Í∞ïÌôîÏÑùÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Ïû•ÎπÑÏùò Í∏∞Î≥∏ Îä•Î†•ÏπòÎ•º Ïò¨Î¶ΩÎãàÎã§. Í∞ïÌôî Î†àÎ≤®Ïù¥ ÎÜíÏùÑÏàòÎ°ù ÏÑ±Í≥µ ÌôïÎ•†Ïù¥ Í∞êÏÜåÌïòÎ©∞, Ïã§Ìå® Ïãú Ìå®ÎÑêÌã∞Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.</li>
                        <li><strong>Î∂ÑÌï¥:</strong> ÌïÑÏöî ÏóÜÎäî Ïû•ÎπÑÎ•º Î∂ÑÌï¥ÌïòÏó¨ Í∞ïÌôîÏÑùÍ≥º ÎßàÎ≤ï Î∂ÄÏó¨ Í∞ÄÎ£®Î•º ÏñªÏäµÎãàÎã§. 'ÏùºÍ¥Ñ Î∂ÑÌï¥' ÌÉ≠ÏóêÏÑú Ïó¨Îü¨ ÏïÑÏù¥ÌÖúÏùÑ ÌïúÎ≤àÏóê Î∂ÑÌï¥Ìï† Ïàò ÏûàÏäµÎãàÎã§.</li>
                        <li><strong>Ï¥àÏõî:</strong> ÎèôÏùºÌïú Ïû•ÎπÑ 2Í∞ú(Í∞ïÌôî Î∞è ÎßàÎ≤ï Î∂ÄÏó¨Í∞Ä ÏóÜÏñ¥Ïïº Ìï®)Î•º Ìï©Ï≥ê ÎçîÏö± Í∞ïÎ†•Ìïú Ïû•ÎπÑÎ°ú ÎßåÎì≠ÎãàÎã§. Ï¥àÏõîÌï† ÎïåÎßàÎã§ Ïû•ÎπÑÏùò Í∏∞Î≥∏ Îä•Î†•ÏπòÍ∞Ä 1.5Î∞∞Ïî© Í∞ïÎ†•Ìï¥ÏßëÎãàÎã§. Ï¥àÏõîÏóêÎäî ÎßéÏùÄ Í≥®ÎìúÏôÄ Ïû¨Î£åÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.</li>
                        <li><strong>ÎßàÎ≤ï Î∂ÄÏó¨:</strong> ÎßàÎ≤ï Î∂ÄÏó¨ Í∞ÄÎ£®ÏôÄ Í≥®ÎìúÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ïû•ÎπÑÏóê Î¨¥ÏûëÏúÑ Ï∂îÍ∞Ä ÏòµÏÖòÏùÑ Î∂ÄÏó¨Ìï©ÎãàÎã§.</li>
                    </ul>

                    <h3>Ïä§ÌÇ¨Í≥º ÌôòÏÉù</h3>
                    <ul>
                        <li><strong>Ïä§ÌÇ¨ Ìä∏Î¶¨:</strong> Í≥®ÎìúÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏßÅÏóÖÎ≥Ñ Ìå®ÏãúÎ∏å Ïä§ÌÇ¨ÏùÑ Î∞∞Ïõå Ï∫êÎ¶≠ÌÑ∞Î•º ÌäπÌôîÌï† Ïàò ÏûàÏäµÎãàÎã§.</li>
                        <li><strong>ÌôòÏÉù:</strong> 30Î†àÎ≤®Ïóê ÎèÑÎã¨ÌïòÎ©¥ ÌôòÏÉùÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§. Î†àÎ≤®, Í≥®Îìú Îì±Ïù¥ Ï¥àÍ∏∞ÌôîÎêòÏßÄÎßå, 'ÌôòÏÉù Ìè¨Ïù∏Ìä∏(RP)'Î•º ÏñªÏñ¥ ÏòÅÍµ¨Ï†ÅÏù∏ Îä•Î†•ÏπòÎ•º Ïò¨Î¶¥ Ïàò ÏûàÏäµÎãàÎã§. Ïû•ÎπÑÏôÄ ÏïÑÏù¥ÌÖúÏùÄ Ïú†ÏßÄÎê©ÎãàÎã§.</li>
                    </ul>

                    <h3>Í∏∞ÌÉÄ ÏΩòÌÖêÏ∏†</h3>
                    <ul>
                        <li><strong>ÌÄòÏä§Ìä∏:</strong> ÏùºÏùº/ÏòÅÍµ¨ ÌÄòÏä§Ìä∏Î•º ÏôÑÎ£åÌïòÍ≥† Î≥¥ÏÉÅÏùÑ Î∞õÏúºÏÑ∏Ïöî.</li>
                        <li><strong>ÏÑúÎ∞îÏù¥Î≤å ÎçòÏ†Ñ:</strong> ÎÅùÏóÜÏù¥ Î™∞Î†§Ïò§Îäî Î™¨Ïä§ÌÑ∞Î•º ÏÉÅÎåÄÎ°ú ÏµúÎåÄÌïú Ïò§Îûò Î≤ÑÌã∞Í≥† Í≥®ÎìúÎ•º ÌöçÎìùÌïòÏÑ∏Ïöî. ÎÜíÏùÄ Ïõ®Ïù¥Î∏åÎ•º Îã¨ÏÑ±Ìï†ÏàòÎ°ù Îçî ÎßéÏùÄ Í≥®ÎìúÎ•º ÏñªÏäµÎãàÎã§.</li>
                        <li><strong>ÎΩëÍ∏∞:</strong> Í≥®ÎìúÎ•º ÏÜåÎ™®ÌïòÏó¨ Î¨¥ÏûëÏúÑ Ïû•ÎπÑ ÎòêÎäî Í∞ïÌôîÏÑùÏùÑ ÌöçÎìùÌï† Ïàò ÏûàÏäµÎãàÎã§. Ïã†Ìôî, Í∂ÅÍ∑π, ÏòÅÏõê Îì±Í∏â Ïû•ÎπÑÎäî Ïò§ÏßÅ ÎΩëÍ∏∞ÏóêÏÑúÎßå ÎÇòÏòµÎãàÎã§.</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button id="close-guide-button" class="button">Îã´Í∏∞</button>
                </div>
            </div>
        `;

        document.body.appendChild(guideButton);
        document.body.appendChild(modalOverlay);

        guideButton.addEventListener('click', () => {
            modalOverlay.style.display = 'flex';
        });

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.style.display = 'none';
            }
        });
        
        document.getElementById('close-guide-button')?.addEventListener('click', () => {
            modalOverlay.style.display = 'none';
        });
        
        guideElementsRendered = true;
    }
    
    function createStartScreen() {
        currentScreen = 'START';
        removeGuideElements();
        removePermanentUI();
        const hasSaveData = !!localStorage.getItem('simpleRPG_saveData');
        
        root.innerHTML = `
            <div class="screen-container">
                <h1 class="logo">‚öîÔ∏è Í∞ÑÎã®RPG üõ°Ô∏è</h1>
                <div id="action-buttons" class="town-actions" style="grid-template-columns: 1fr; max-width: 250px; gap: 0.8rem;">
                    <button data-action="new-game" class="button">ÏÉà Í≤åÏûÑ</button>
                    <button data-action="continue-game" class="button" style="${hasSaveData ? '' : 'display: none;'}">Ïù¥Ïñ¥ÌïòÍ∏∞</button>
                    <button data-action="delete-save" class="button" style="${hasSaveData ? '' : 'display: none;'} background-color: var(--monster-hp-color);">Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú</button>
                </div>
            </div>
        `;

        document.getElementById('action-buttons')?.addEventListener('click', (e) => {
            const action = e.target.closest('button')?.dataset.action;
            if (action === 'new-game') {
                if (hasSaveData && !confirm('Í∏∞Ï°¥ Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏäµÎãàÎã§. Ï†ïÎßêÎ°ú ÏÉà Í≤åÏûÑÏùÑ ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå? Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
                    return;
                }
                deleteSaveData(false); // Silently delete
                createDifficultySelectionScreen();
            } else if (action === 'continue-game') {
                if(loadGameState()) {
                    renderTownScreen();
                } else {
                    alert("Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏÉà Í≤åÏûÑÏùÑ ÏãúÏûëÌï©ÎãàÎã§.");
                    createDifficultySelectionScreen();
                }
            } else if (action === 'delete-save') {
                if (confirm('Ï†ïÎßêÎ°ú Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                    deleteSaveData(true);
                }
            }
        });
    }


    function createItemInstance(itemId) {
        const itemData = ITEM_DATABASE.find(i => i.id === itemId);
        if (!itemData) return null;

        const newItem = JSON.parse(JSON.stringify(itemData));
        newItem.enhancementLevel = 0;
        newItem.enchantment = null;
        newItem.isLocked = false;
        newItem.transcendenceLevel = 0;
        return newItem;
    }

    function createDifficultySelectionScreen() {
        currentScreen = 'DIFFICULTY_SELECTION';
        removeGuideElements();
        removePermanentUI();
        root.innerHTML = `
            <div class="screen-container">
                 <h1 class="logo">‚öîÔ∏è Í∞ÑÎã®RPG üõ°Ô∏è</h1>
                <h1>ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù</h1>
                <p>Î™®ÌóòÏùò ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
                <div class="difficulty-selection">
                    <button class="difficulty-card" data-difficulty="Ïâ¨ÏõÄ">
                        <h2>Ïâ¨ÏõÄ</h2>
                        <p>Î™¨Ïä§ÌÑ∞Í∞Ä ÏïΩÌï¥ÏßÄÍ≥†, Îçî ÎßéÏùÄ ÏûêÏõêÏúºÎ°ú ÏãúÏûëÌï©ÎãàÎã§. Ìé∏ÏïàÌïú ÌîåÎ†àÏù¥Ïóê Ï†ÅÌï©Ìï©ÎãàÎã§.</p>
                    </button>
                    <button class="difficulty-card" data-difficulty="Î≥¥ÌÜµ">
                        <h2>Î≥¥ÌÜµ</h2>
                        <p>ÌëúÏ§ÄÏ†ÅÏù∏ RPG Í≤ΩÌóòÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.</p>
                    </button>
                    <button class="difficulty-card" data-difficulty="Ïñ¥Î†§ÏõÄ">
                        <h2>Ïñ¥Î†§ÏõÄ</h2>
                        <p>Î™¨Ïä§ÌÑ∞Í∞Ä Îß§Ïö∞ Í∞ïÎ†•Ìï©ÎãàÎã§. Î≥¥ÏÉÅÏù¥ ÌÅ¨ÏßÄÎßå, ÏÉÅÎãπÌïú ÎèÑÏ†ÑÏùÑ ÏöîÍµ¨Ìï©ÎãàÎã§.</p>
                    </button>
                    <button class="difficulty-card" data-difficulty="ÌïòÎìúÏΩîÏñ¥">
                        <h2 style="color: var(--monster-hp-color);">ÌïòÎìúÏΩîÏñ¥</h2>
                        <p>Ï£ΩÏúºÎ©¥ Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÎäî Í∂ÅÍ∑πÏùò ÎèÑÏ†Ñ Î™®ÎìúÏûÖÎãàÎã§. Îß§Ïö∞ ÎÜíÏùÄ Î≥¥ÏÉÅÏù¥ Ï£ºÏñ¥ÏßëÎãàÎã§.</p>
                    </button>
                </div>
            </div>
        `;

        document.querySelectorAll('.difficulty-card').forEach(card => {
            card.addEventListener('click', (e) => {
                currentDifficulty = e.currentTarget.dataset.difficulty;
                createClassSelectionScreen();
            });
        });
    }

    function renderDifficultyChangeScreen() {
      currentScreen = 'DIFFICULTY_CHANGE';
      renderPermanentUI();
      root.innerHTML = `
        <div class="screen-container">
          <h1>ÎÇúÏù¥ÎèÑ Î≥ÄÍ≤Ω</h1>
          <p>Î≥ÄÍ≤ΩÌï† ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. Îã§Ïùå ÎçòÏ†ÑÎ∂ÄÌÑ∞ Ï†ÅÏö©Îê©ÎãàÎã§. (ÌòÑÏû¨: ${currentDifficulty})</p>
           <p style="font-size: 0.8rem; color: var(--rarity-legendary);">ÌïòÎìúÏΩîÏñ¥ Î™®ÎìúÎ°úÎäî Î≥ÄÍ≤ΩÌï† Ïàò ÏóÜÏúºÎ©∞, ÌïòÎìúÏΩîÏñ¥ Î™®ÎìúÏóêÏÑú Îã§Î•∏ ÎÇúÏù¥ÎèÑÎ°ú Î≥ÄÍ≤ΩÌï† ÏàòÎèÑ ÏóÜÏäµÎãàÎã§.</p>
          <div class="difficulty-selection">
            <button class="difficulty-card" data-difficulty="Ïâ¨ÏõÄ" ${currentDifficulty === 'ÌïòÎìúÏΩîÏñ¥' ? 'disabled' : ''}><h2>Ïâ¨ÏõÄ</h2><p>Ìé∏ÏïàÌïú ÌîåÎ†àÏù¥.</p></button>
            <button class="difficulty-card" data-difficulty="Î≥¥ÌÜµ" ${currentDifficulty === 'ÌïòÎìúÏΩîÏñ¥' ? 'disabled' : ''}><h2>Î≥¥ÌÜµ</h2><p>ÌëúÏ§ÄÏ†ÅÏù∏ Í≤ΩÌóò.</p></button>
            <button class="difficulty-card" data-difficulty="Ïñ¥Î†§ÏõÄ" ${currentDifficulty === 'ÌïòÎìúÏΩîÏñ¥' ? 'disabled' : ''}><h2>Ïñ¥Î†§ÏõÄ</h2><p>Îçî ÌÅ∞ ÎèÑÏ†ÑÍ≥º Î≥¥ÏÉÅ.</p></button>
          </div>
          <button id="back-to-town" class="button" style="margin-top: 1rem; width: 100%;">ÎßàÏùÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        </div>
      `;
      document.querySelectorAll('.difficulty-card:not([disabled])').forEach(card => {
        card.addEventListener('click', (e) => {
          const newDifficulty = e.currentTarget.dataset.difficulty;
          if (newDifficulty !== currentDifficulty) {
            currentDifficulty = newDifficulty;
            saveGameState();
            alert(`ÎÇúÏù¥ÎèÑÍ∞Ä ${newDifficulty}(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
          }
          renderTownScreen();
        });
      });
      document.getElementById('back-to-town')?.addEventListener('click', renderTownScreen);
    }


    function createClassSelectionScreen() {
        currentScreen = 'CLASS_SELECTION';
        removePermanentUI();
        root.innerHTML = `
            <div class="screen-container">
                <h1>ÏßÅÏóÖ ÏÑ†ÌÉù</h1>
                <p>Î™®ÌóòÏùÑ Ìï®ÍªòÌï† ÎãπÏã†Ïùò ÏßÅÏóÖÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
                <div class="class-selection">
                    <button class="class-card" data-class="Ï†ÑÏÇ¨">
                        <h2>Ï†ÑÏÇ¨ üõ°Ô∏è</h2>
                        <p>ÎÜíÏùÄ Ï≤¥Î†•Í≥º Î∞©Ïñ¥Î†•. Ï†ÅÏùÑ ÏïΩÌôîÏãúÌÇ§Í≥† Î≤ÑÌã∞Îäî Ï†ÑÌà¨Î•º Ïù¥ÎÅåÏñ¥Í∞ëÎãàÎã§.</p>
                    </button>
                    <button class="class-card" data-class="ÎßàÎ≤ïÏÇ¨">
                        <h2>ÎßàÎ≤ïÏÇ¨ üî•</h2>
                        <p>Í∞ïÎ†•Ìïú ÏõêÏÜå ÎßàÎ≤ïÏúºÎ°ú Ï†ÅÏùÑ Î∂àÌÉúÏö∞Í±∞ÎÇò ÏñºÎ¶ΩÎãàÎã§.</p>
                    </button>
                    <button class="class-card" data-class="ÏïîÏÇ¥Ïûê">
                        <h2>ÏïîÏÇ¥Ïûê üí®</h2>
                        <p>ÏπòÎ™ÖÏ†ÅÏù∏ Í≥µÍ≤©Í≥º ÎÜíÏùÄ ÌöåÌîºÏú®Î°ú Ï†ÅÏùÑ ÏàúÏãùÍ∞ÑÏóê Ï†úÏïïÌï©ÎãàÎã§.</p>
                    </button>
                    <button class="class-card" data-class="Í∂ÅÏàò">
                        <h2>Í∂ÅÏàò üèπ</h2>
                        <p>ÎÇ†Ïπ¥Î°úÏö¥ ÌôîÏÇ¥Î°ú ÏõêÍ±∞Î¶¨ÏóêÏÑú Ï†ÅÏùò ÏïΩÏ†êÏùÑ ÎÖ∏Î¶ΩÎãàÎã§. ÏπòÎ™ÖÌÉÄ Í≥µÍ≤©Ïóê ÌäπÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§.</p>
                    </button>
                </div>
            </div>
        `;

        document.querySelectorAll('.class-card').forEach(card => {
            card.addEventListener('click', (e) => {
                const selectedClass = e.currentTarget.dataset.class;
                const playerName = prompt("Ïö©ÏÇ¨ÎãòÏùò Ïù¥Î¶ÑÏùÄ Î¨¥ÏóáÏûÖÎãàÍπå?", "Ïö©ÏÇ¨") || "Ïö©ÏÇ¨";
                 if (selectedClass) {
                    initializeGame(selectedClass, playerName);
                }
            });
        });
    }

    function createClassChangeScreen() {
        currentScreen = 'CLASS_SELECTION';
        renderPermanentUI();
        root.innerHTML = `
            <div class="screen-container">
                <h1>ÏßÅÏóÖ Î≥ÄÍ≤Ω</h1>
                <p>ÏÉàÎ°úÏö¥ ÏßÅÏóÖÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. Í∏∞Ï°¥ ÏßÅÏóÖÍ≥º Îã§Î•∏ ÏßÅÏóÖÏùÑ ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§.</p>
                <div class="class-selection">
                    <button class="class-card" data-class="Ï†ÑÏÇ¨" ${player.className === 'Ï†ÑÏÇ¨' ? 'disabled' : ''}>
                        <h2>Ï†ÑÏÇ¨ üõ°Ô∏è</h2>
                        <p>ÎÜíÏùÄ Ï≤¥Î†•Í≥º Î∞©Ïñ¥Î†•. Ï†ÅÏùÑ ÏïΩÌôîÏãúÌÇ§Í≥† Î≤ÑÌã∞Îäî Ï†ÑÌà¨Î•º Ïù¥ÎÅåÏñ¥Í∞ëÎãàÎã§.</p>
                    </button>
                    <button class="class-card" data-class="ÎßàÎ≤ïÏÇ¨" ${player.className === 'ÎßàÎ≤ïÏÇ¨' ? 'disabled' : ''}>
                        <h2>ÎßàÎ≤ïÏÇ¨ üî•</h2>
                        <p>Í∞ïÎ†•Ìïú ÏõêÏÜå ÎßàÎ≤ïÏúºÎ°ú Ï†ÅÏùÑ Î∂àÌÉúÏö∞Í±∞ÎÇò ÏñºÎ¶ΩÎãàÎã§.</p>
                    </button>
                    <button class="class-card" data-class="ÏïîÏÇ¥Ïûê" ${player.className === 'ÏïîÏÇ¥Ïûê' ? 'disabled' : ''}>
                        <h2>ÏïîÏÇ¥Ïûê üí®</h2>
                        <p>ÏπòÎ™ÖÏ†ÅÏù∏ Í≥µÍ≤©Í≥º ÎÜíÏùÄ ÌöåÌîºÏú®Î°ú Ï†ÅÏùÑ ÏàúÏãùÍ∞ÑÏóê Ï†úÏïïÌï©ÎãàÎã§.</p>
                    </button>
                    <button class="class-card" data-class="Í∂ÅÏàò" ${player.className === 'Í∂ÅÏàò' ? 'disabled' : ''}>
                        <h2>Í∂ÅÏàò üèπ</h2>
                        <p>ÎÇ†Ïπ¥Î°úÏö¥ ÌôîÏÇ¥Î°ú ÏõêÍ±∞Î¶¨ÏóêÏÑú Ï†ÅÏùò ÏïΩÏ†êÏùÑ ÎÖ∏Î¶ΩÎãàÎã§. ÏπòÎ™ÖÌÉÄ Í≥µÍ≤©Ïóê ÌäπÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§.</p>
                    </button>
                </div>
                <button id="back-to-town" class="button" style="margin-top: 1rem; width: 100%;">ÎßàÏùÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
            </div>
        `;

        document.querySelectorAll('.class-card:not([disabled])').forEach(card => {
            card.addEventListener('click', (e) => {
                const newClass = e.currentTarget.dataset.class;
                if (confirm(`Ï†ïÎßêÎ°ú ÏßÅÏóÖÏùÑ ${newClass}(Ïúº)Î°ú Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÎπÑÏö©: ${CLASS_CHANGE_COST}Í≥®Îìú)`)) {
                    if (player.gold >= CLASS_CHANGE_COST) {
                        player.gold -= CLASS_CHANGE_COST;
                        player.className = newClass;
                        player.level = 1;
                        player.xp = 0;
                        player.nextLevelXp = 100;
                        player.skillPoints = 0;
                        player.skills = {}; // Reset skills
                        player.ultimateSkill.level = 1; // Reset ultimate level
                        player.ultimateSkill.cooldownLeft = 0;
                        updatePlayerStats();
                        saveGameState();
                        alert(`${newClass}(Ïúº)Î°ú Ï†ÑÏßÅÌñàÏäµÎãàÎã§!`);
                        renderTownScreen();
                    } else {
                        alert('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.');
                    }
                }
            });
        });
        document.getElementById('back-to-town')?.addEventListener('click', renderTownScreen);
    }
    
    function initializeGame(className, playerName) {
        const classData = CLASSES[className];
        const difficultyData = DIFFICULTY_SETTINGS[currentDifficulty];

        player = {
            name: playerName,
            level: 1,
            xp: 0,
            nextLevelXp: 100,
            className: className,
            maxHp: classData.baseHp,
            currentHp: classData.baseHp,
            attackPower: classData.baseAtk,
            defense: classData.baseDef,
            critChance: classData.crit,
            critDamage: CRIT_MULTIPLIER,
            evadeChance: classData.evade,
            gold: difficultyData.startGold,
            potions: difficultyData.startPotions,
            attackPotions: difficultyData.startAttackPotions,
            enhancementStones: 0,
            enchantmentDust: 0,
            inventory: [],
            equipment: {
                weapon: null,
                armor: null,
                accessory: null,
                relic: null,
            },
            skills: {},
            skillPoints: 0,
            ultimateSkill: {
              id: ULTIMATE_SKILLS[className].id,
              name: ULTIMATE_SKILLS[className].name,
              cooldown: ULTIMATE_SKILLS[className].cooldown,
              cooldownLeft: 0,
              level: 1,
            },
            selectedUltimateId: ULTIMATE_SKILLS[className].id,
            unlockedUltimates: [ULTIMATE_SKILLS[className].id],
            statusEffects: {},
            buffs: {},
            rebirths: 0,
            rebirthPoints: 0,
            rebirthUpgrades: {},
            permanentQuests: PERMANENT_QUESTS_DATA.map(q => ({...q, progress: 0, completed: false})),
            isLiberated: false,
        };
        
        dungeonLevel = 1;
        dungeonFloor = 1;

        generateNewDailyQuests();

        updatePlayerStats();
        saveGameState();
        renderTownScreen();
    }
    
    function getEquippedItem(slot) {
        const itemInstance = player.equipment[slot];
        return itemInstance ? getItemWithStats(itemInstance) : null;
    }

    function getItemWithStats(itemInstance) {
        if (!itemInstance) return null;

        const baseItem = ITEM_DATABASE.find(i => i.id === itemInstance.id);
        if (!baseItem) return null;

        const item = JSON.parse(JSON.stringify(itemInstance)); // Deep copy to avoid mutation
        item.stats = JSON.parse(JSON.stringify(baseItem.stats));
        
        // Transcendence multiplier
        const transcendenceMultiplier = Math.pow(1.5, item.transcendenceLevel);

        // Apply transcendence bonus
        for (const stat in item.stats) {
            item.stats[stat] = Math.round(item.stats[stat] * transcendenceMultiplier);
        }

        // Apply enhancement bonus
        if (item.enhancementLevel > 0) {
            const enhancementBonus = getEnhancementBonus(item, item.enhancementLevel);
            for (const stat in enhancementBonus) {
                if (item.stats[stat]) {
                    item.stats[stat] += enhancementBonus[stat];
                } else {
                    item.stats[stat] = enhancementBonus[stat];
                }
            }
        }
        
        // Apply enchantment bonus
        if (item.enchantment) {
            for (const stat in item.enchantment.effects) {
                if (stat.includes('Percent')) {
                    // Handle percentage stats separately during total stat calculation
                } else {
                    item.stats[stat] = (item.stats[stat] || 0) + item.enchantment.effects[stat];
                }
            }
        }

        return item;
    }

    function getEnhancementBonus(item, level) {
        const bonus = {};
        if (!item.stats) return bonus;

        const primaryStat = Object.keys(item.stats)[0];
        const baseValue = item.stats[primaryStat];
        let multiplier = 0;

        // More granular bonus calculation
        if (item.type === 'weapon') {
            multiplier = 0.2; // Weapons get a stronger bonus
        } else if (item.type === 'armor') {
            multiplier = 0.15;
        } else {
            multiplier = 0.1;
        }

        // Rarer items get better scaling
        const rarityMultipliers = { common: 1, uncommon: 1.2, rare: 1.5, legendary: 2, mythic: 2.5, ultimate: 3.5, eternal: 5 };
        multiplier *= rarityMultipliers[item.rarity] || 1;

        bonus[primaryStat] = Math.ceil(baseValue * multiplier * level);
        
        if (item.type === 'armor' && item.stats.defense) {
             bonus.defense = (bonus.defense || 0) + Math.ceil(item.stats.defense * 0.2 * level * rarityMultipliers[item.rarity]);
        }

        return bonus;
    }


    function updatePlayerStats() {
        if (!player) return;

        const baseClass = CLASSES[player.className];
        let newStats = {
            maxHp: baseClass.baseHp,
            attackPower: baseClass.baseAtk,
            defense: baseClass.baseDef,
            critChance: baseClass.crit,
            critDamage: CRIT_MULTIPLIER,
            evadeChance: baseClass.evade,
        };

        // Rebirth Upgrades (Flat)
        const rebirthAtk = player.rebirthUpgrades.base_atk ? (player.rebirthUpgrades.base_atk * 2) : 0;
        const rebirthHp = player.rebirthUpgrades.base_hp ? (player.rebirthUpgrades.base_hp * 10) : 0;
        newStats.attackPower += rebirthAtk;
        newStats.maxHp += rebirthHp;

        // Skill Tree Bonuses (Flat)
        for (const skillId in player.skills) {
            const skillLevel = player.skills[skillId];
            if (skillLevel > 0) {
                const skillInfo = SKILL_DATA[player.className][skillId];
                if (skillInfo && skillInfo.effects) {
                    skillInfo.effects(skillLevel).forEach(effect => {
                        if (effect.stat && !effect.stat.includes('Percent')) {
                            newStats[effect.stat] = (newStats[effect.stat] || 0) + effect.value;
                        }
                    });
                }
            }
        }
        
        // Equipment Bonuses (Flat)
        let equipmentPercentBonuses = {};
        for (const slot in player.equipment) {
            const item = getEquippedItem(slot);
            if (item) {
                for (const stat in item.stats) {
                    newStats[stat] = (newStats[stat] || 0) + item.stats[stat];
                }
                if (item.enchantment) {
                    for (const effectStat in item.enchantment.effects) {
                        if (effectStat.includes('Percent')) {
                             equipmentPercentBonuses[effectStat] = (equipmentPercentBonuses[effectStat] || 0) + item.enchantment.effects[effectStat];
                        }
                    }
                }
            }
        }

        // Handle 'allStatsPercent' from relics or enchantments
        let totalAllStatsPercent = 0;
        const relic = getEquippedItem('relic');
        if (relic && relic.stats.allStatsPercent) {
            totalAllStatsPercent += relic.stats.allStatsPercent;
        }
        if (relic && relic.enchantment && relic.enchantment.effects.allStatsPercent) {
            totalAllStatsPercent += relic.enchantment.effects.allStatsPercent;
        }

        // Apply Percentage-based bonuses
        const baseStatsForPercentCalc = { ...newStats };

        // Apply allStatsPercent
        if (totalAllStatsPercent > 0) {
            newStats.maxHp += Math.round(baseStatsForPercentCalc.maxHp * totalAllStatsPercent);
            newStats.attackPower += Math.round(baseStatsForPercentCalc.attackPower * totalAllStatsPercent);
            newStats.defense += Math.round(baseStatsForPercentCalc.defense * totalAllStatsPercent);
        }

        // Apply specific percent bonuses from enchantments
        for (const stat in equipmentPercentBonuses) {
            const baseStatName = stat.replace('Percent', '');
            if (newStats[baseStatName]) {
                newStats[baseStatName] += Math.round(baseStatsForPercentCalc[baseStatName] * equipmentPercentBonuses[stat]);
            }
        }

        // Apply Buffs (both flat and percent)
        for (const buffName in player.buffs) {
            const buff = player.buffs[buffName];
            if (buff.isPercent) {
                newStats[buff.stat] *= (1 + buff.value);
            } else {
                newStats[buff.stat] += buff.value;
            }
        }
        
        // Rebirth Upgrades (Percent)
        const goldBonus = player.rebirthUpgrades.gold_gain ? (1 + player.rebirthUpgrades.gold_gain * 0.05) : 1;
        const xpBonus = player.rebirthUpgrades.xp_gain ? (1 + player.rebirthUpgrades.xp_gain * 0.05) : 1;
        // These are applied at the time of gain, not to stats.
        
        // Final assignment, ensuring HP integrity
        const hpRatio = player.maxHp > 0 ? (player.currentHp / player.maxHp) : 1;
        player = { ...player, ...newStats };
        player.currentHp = Math.round(player.maxHp * hpRatio);
        if (player.currentHp > player.maxHp) player.currentHp = player.maxHp;

        saveGameState();
    }


    function createMonster() {
        const difficultyMods = DIFFICULTY_SETTINGS[currentDifficulty];
        const isBoss = dungeonFloor % 5 === 0;
        const monsterPool = isBoss ? bossList : monsterList;
        
        const baseMonster = { ...monsterPool[Math.floor(Math.random() * monsterPool.length)] };
        
        const levelMultiplier = 1 + (dungeonLevel - 1) * 0.2 + (dungeonFloor - 1) * 0.05;
        const bossMultiplier = isBoss ? 1.5 + (dungeonLevel * 0.1) : 1;

        monster = {
            ...baseMonster,
            maxHp: Math.ceil(baseMonster.baseHp * levelMultiplier * bossMultiplier * difficultyMods.monsterHpMod),
            currentHp: Math.ceil(baseMonster.baseHp * levelMultiplier * bossMultiplier * difficultyMods.monsterHpMod),
            attack: Math.ceil(baseMonster.baseAttack * levelMultiplier * bossMultiplier * difficultyMods.monsterAtkMod),
            xp: Math.ceil(baseMonster.xp * levelMultiplier * bossMultiplier * difficultyMods.rewardMod * (player.rebirthUpgrades.xp_gain ? (1 + player.rebirthUpgrades.xp_gain * 0.05) : 1)),
            gold: Math.ceil(baseMonster.gold * levelMultiplier * bossMultiplier * difficultyMods.rewardMod * (player.rebirthUpgrades.gold_gain ? (1 + player.rebirthUpgrades.gold_gain * 0.05) : 1)),
            isBoss: isBoss,
            statusEffects: {},
        };
    }
    
    function createSurvivalMonster(wave) {
        const difficultyMods = DIFFICULTY_SETTINGS[currentDifficulty];
        const isBossWave = wave % 10 === 0;
        const monsterPool = isBossWave ? bossList : monsterList;
        const baseMonster = { ...monsterPool[Math.floor(Math.random() * monsterPool.length)] };

        const waveMultiplier = 1 + (wave * 0.15);
        const bossMultiplier = isBossWave ? 2 : 1;

        return {
            ...baseMonster,
            maxHp: Math.ceil(baseMonster.baseHp * waveMultiplier * bossMultiplier * difficultyMods.monsterHpMod),
            currentHp: Math.ceil(baseMonster.baseHp * waveMultiplier * bossMultiplier * difficultyMods.monsterHpMod),
            attack: Math.ceil(baseMonster.baseAttack * waveMultiplier * bossMultiplier * difficultyMods.monsterAtkMod),
            xp: 0, // No XP in survival
            gold: Math.ceil(baseMonster.gold * waveMultiplier * difficultyMods.rewardMod * (player.rebirthUpgrades.gold_gain ? (1 + player.rebirthUpgrades.gold_gain * 0.05) : 1)),
            isBoss: isBossWave,
            statusEffects: {},
        };
    }


    function addMessage(text, className = '') {
        const message = `<p class="${className}">${text}</p>`;
        messageLog.insertAdjacentHTML('afterbegin', message);
        if (messageLog.children.length > 50) {
            messageLog.lastElementChild.remove();
        }
    }
    
    // --- Gacha Logic ---
    function performGachaDraw(isProbUp = false) {
        const rand = Math.random();
        let rarity;
        
        if (isProbUp) {
            if (rand < 0.001) rarity = 'eternal';    // 0.1%
            else if (rand < 0.01) rarity = 'ultimate';  // 0.9%
            else if (rand < 0.06) rarity = 'mythic';    // 5%
            else if (rand < 0.20) rarity = 'legendary'; // 14%
            else if (rand < 0.50) rarity = 'rare';      // 30%
            else rarity = 'uncommon'; // 50%
        } else {
            if (rand < 0.0005) rarity = 'eternal';    // 0.05%
            else if (rand < 0.005) rarity = 'ultimate';   // 0.45%
            else if (rand < 0.02) rarity = 'mythic';     // 1.5%
            else if (rand < 0.10) rarity = 'legendary';  // 8%
            else if (rand < 0.30) rarity = 'rare';       // 20%
            else if (rand < 0.60) rarity = 'uncommon';   // 30%
            else rarity = 'common'; // 40%
        }
        
        const gachaPool = ITEM_DATABASE.filter(item => item.rarity); // All items with rarity are potential gacha items
        const itemsOfRarity = gachaPool.filter(item => item.rarity === rarity);
        
        const stonePool = {
            common: { name: 'ÌïòÍ∏â Í∞ïÌôîÏÑù', count: Math.floor(Math.random() * 3) + 1, rarity: 'common' },
            uncommon: { name: 'Ï§ëÍ∏â Í∞ïÌôîÏÑù', count: Math.floor(Math.random() * 5) + 3, rarity: 'uncommon' },
            rare: { name: 'ÏÉÅÍ∏â Í∞ïÌôîÏÑù', count: Math.floor(Math.random() * 8) + 5, rarity: 'rare' },
        };
        
        const possiblePrizes = [...itemsOfRarity];
        if (stonePool[rarity]) {
            possiblePrizes.push(stonePool[rarity]);
        }
        
        if (possiblePrizes.length === 0) {
            // Default to enhancement stones if no items of that rarity are available
            return stonePool.uncommon;
        }

        const prize = possiblePrizes[Math.floor(Math.random() * possiblePrizes.length)];
        
        if (prize.id) { // It's an item
            return createItemInstance(prize.id);
        } else { // It's a stone pack
            return prize;
        }
    }

    // --- Game Screens ---
    function renderTownScreen() {
        currentScreen = 'TOWN';
        renderPermanentUI();
        renderGuideElements();

        const skillPointsBadge = player.skillPoints > 0 ? `<span class="notification-badge">${player.skillPoints}</span>` : '';
        const dailyQuestBadge = dailyQuests.some(q => q.progress >= q.target && !q.claimed) ? `<span class="notification-badge">!</span>` : '';

        root.innerHTML = `
            <div class="screen-container town-screen">
                <h1>ÎßàÏùÑ</h1>
                <div class="player-card">
                    ${renderPlayerCard(false)}
                </div>
                <div id="action-buttons" class="town-actions">
                    <button data-action="enter-dungeon" class="button">ÎçòÏ†Ñ ÏûÖÏû• (ÌòÑÏû¨ ${dungeonLevel}Ï∏µ)</button>
                    <button data-action="enter-survival" class="button" style="background-color: var(--survival-color);">ÏÑúÎ∞îÏù¥Î≤å ÎçòÏ†Ñ</button>
                    <button data-action="shop" class="button">ÏÉÅÏ†ê</button>
                    <button data-action="equipment" class="button">Ïû•ÎπÑ</button>
                    <button data-action="blacksmith" class="button">ÎåÄÏû•Í∞Ñ</button>
                    <button data-action="skill-tree" class="button">Ïä§ÌÇ¨ Ìä∏Î¶¨ ${skillPointsBadge}</button>
                    <button data-action="quests" class="button">ÌÄòÏä§Ìä∏ ${dailyQuestBadge}</button>
                    <button data-action="gacha" class="button">ÎΩëÍ∏∞</button>
                    <button data-action="rebirth" class="button" style="background-color: var(--rebirth-color); display: ${player.level >= REBIRTH_LEVEL_REQ ? 'block' : 'none'};">ÌôòÏÉù</button>
                </div>
                <div id="message-log"></div>
            </div>
        `;

        messageLog = document.getElementById('message-log');
        
        document.getElementById('action-buttons')?.addEventListener('click', (e) => {
            const action = e.target.closest('button')?.dataset.action;
            if (!action) return;

            switch (action) {
                case 'enter-dungeon':
                    if (isInventoryFull()) {
                        alert('Ïù∏Î≤§ÌÜ†Î¶¨Í∞Ä Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§. Ïû•ÎπÑÎ•º ÎπÑÏö∞Í≥† Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.');
                        return;
                    }
                    createMonster();
                    renderBattleScreen();
                    break;
                case 'enter-survival':
                    if (confirm('ÏÑúÎ∞îÏù¥Î≤å ÎçòÏ†ÑÏóê ÏûÖÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ï£ΩÏùÑ ÎïåÍπåÏßÄ Î™¨Ïä§ÌÑ∞ÏôÄ Ïã∏Ïö∞Î©∞, Ï≤òÏπòÌïú Ïõ®Ïù¥Î∏åÏóê Îî∞Îùº Í≥®ÎìúÎ•º ÌöçÎìùÌï©ÎãàÎã§. Î¨ºÏïΩÏùÄ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.')) {
                        startSurvivalMode();
                    }
                    break;
                case 'shop':
                    renderShopScreen();
                    break;
                case 'equipment':
                    renderEquipmentScreen();
                    break;
                case 'blacksmith':
                    renderBlacksmithScreen();
                    break;
                case 'skill-tree':
                    renderSkillTreeScreen();
                    break;
                case 'quests':
                    renderQuestScreen();
                    break;
                case 'gacha':
                    renderGachaScreen();
                    break;
                case 'rebirth':
                    renderRebirthScreen();
                    break;
            }
        });
        document.querySelector('.name-change-icon')?.addEventListener('click', changePlayerName);
        document.querySelector('.player-class')?.addEventListener('click', () => {
             if (player.rebirths > 0) {
                 if(confirm(`ÏßÅÏóÖÏùÑ Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå? ÏßÅÏóÖ Î≥ÄÍ≤Ω Ïãú Î†àÎ≤® 1Î°ú ÎèåÏïÑÍ∞ÄÎ©∞, Ïä§ÌÇ¨Ïù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§. (ÎπÑÏö©: ${CLASS_CHANGE_COST}Í≥®Îìú)`)) {
                    createClassChangeScreen();
                 }
            } else {
                alert('ÏßÅÏóÖ Î≥ÄÍ≤ΩÏùÄ ÌôòÏÉù ÌõÑÏóê Í∞ÄÎä•Ìï©ÎãàÎã§.');
            }
        });
         document.querySelector('.dungeon-progress')?.addEventListener('click', () => {
             renderDifficultyChangeScreen();
         });
    }

    function changePlayerName() {
        const newName = prompt("ÏÉàÎ°úÏö¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", player.name);
        if (newName && newName.trim().length > 0) {
            player.name = newName.trim();
            saveGameState();
            renderTownScreen(); // Re-render to show the new name
        }
    }
    
    function startSurvivalMode() {
        currentScreen = 'SURVIVAL';
        survivalWave = 1;
        player.currentHp = player.maxHp; // Full heal before starting
        monster = createSurvivalMonster(survivalWave);
        renderBattleScreen(true);
    }
    
    function renderGachaScreen() {
        currentScreen = 'GACHA';
        root.innerHTML = `
            <div class="screen-container shop-container">
                <h1>ÎΩëÍ∏∞</h1>
                <div class="gold-sp-display top-display">
                    <p>üí∞ Í≥®Îìú: ${player.gold.toLocaleString()}</p>
                </div>
                <div class="shop-items">
                    <div class="shop-item">
                        <span>ÏùºÎ∞ò ÎΩëÍ∏∞ (1Ìöå)</span>
                        <button class="button" data-gacha-type="single">üí∞ ${GACHA_COST_SINGLE.toLocaleString()}</button>
                    </div>
                    <div class="shop-item">
                        <span>ÏùºÎ∞ò ÎΩëÍ∏∞ (10Ìöå)</span>
                        <button class="button" data-gacha-type="ten">üí∞ ${GACHA_COST_TEN.toLocaleString()}</button>
                    </div>
                    <div class="shop-item">
                        <span>ÌôïÎ•†ÏóÖ ÎΩëÍ∏∞ (1Ìöå)</span>
                        <button class="button" data-gacha-type="prob_up" style="background-color: var(--enchant-color);">üí∞ ${GACHA_COST_PROB_UP.toLocaleString()}</button>
                    </div>
                    <p style="font-size: 0.7rem; color: var(--border-color); margin-top: 1rem;">
                        ÌôïÎ•†ÏóÖ ÎΩëÍ∏∞ÏóêÏÑúÎäî ÏùºÎ∞ò Îì±Í∏â ÏïÑÏù¥ÌÖúÏù¥ Îì±Ïû•ÌïòÏßÄ ÏïäÏúºÎ©∞, ÏÉÅÏúÑ Îì±Í∏â ÏïÑÏù¥ÌÖú ÌöçÎìù ÌôïÎ•†Ïù¥ Ï¶ùÍ∞ÄÌï©ÎãàÎã§.<br>
                        Ïã†Ìôî, Í∂ÅÍ∑π, ÏòÅÏõê Îì±Í∏â Ïû•ÎπÑÏôÄ ÏùºÎ∂Ä Ïú†Î¨ºÏùÄ ÎΩëÍ∏∞ÏóêÏÑúÎßå ÌöçÎìùÌï† Ïàò ÏûàÏäµÎãàÎã§.
                    </p>
                </div>
                <div id="message-log" style="height: 200px; margin-top: 1rem;"></div>
                <button id="back-to-town" class="button">ÎßàÏùÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
            </div>
        `;

        messageLog = document.getElementById('message-log');

        document.querySelectorAll('[data-gacha-type]').forEach(button => {
            button.addEventListener('click', (e) => handleGacha(e.currentTarget.dataset.gachaType));
        });

        document.getElementById('back-to-town').addEventListener('click', renderTownScreen);
    }
    
    function handleGacha(type) {
        let cost = 0;
        let numDraws = 1;
        let isProbUp = false;

        switch(type) {
            case 'single':
                cost = GACHA_COST_SINGLE;
                break;
            case 'ten':
                cost = GACHA_COST_TEN;
                numDraws = 10;
                break;
            case 'prob_up':
                cost = GACHA_COST_PROB_UP;
                isProbUp = true;
                break;
        }

        if (player.gold < cost) {
            alert('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.');
            return;
        }

        if (!canAddItem(numDraws)) {
            alert(`Ïù∏Î≤§ÌÜ†Î¶¨Ïóê ÏµúÏÜå ${numDraws}Ïπ∏Ïùò Ïó¨Ïú† Í≥µÍ∞ÑÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.`);
            return;
        }

        player.gold -= cost;
        
        const results = [];
        let logMessage = `${numDraws}Ìöå ÎΩëÍ∏∞ Í≤∞Í≥º:<br>`;
        
        for (let i = 0; i < numDraws; i++) {
            const result = performGachaDraw(isProbUp);
            results.push(result);
        }

        let totalStonesGained = 0;
        let highestRarity = 'common';
        const rarityOrder = ['common', 'uncommon', 'rare', 'legendary', 'mythic', 'ultimate', 'eternal'];

        results.forEach(result => {
            if (result.id) { // It's an item
                player.inventory.push(result);
                logMessage += `<span class="rarity-${result.rarity}">${result.name}</span>, `;
                if (rarityOrder.indexOf(result.rarity) > rarityOrder.indexOf(highestRarity)) {
                    highestRarity = result.rarity;
                }
            } else { // It's stones
                player.enhancementStones += result.count;
                totalStonesGained += result.count;
                logMessage += `<span class="rarity-${result.rarity}">${result.name} x${result.count}</span>, `;
            }
        });

        addMessage(logMessage.slice(0, -2));
        
        if (numDraws > 1) {
            alert(`ÌöçÎìùÌïú ÏµúÍ≥† Îì±Í∏â ÏïÑÏù¥ÌÖú: ${highestRarity.charAt(0).toUpperCase() + highestRarity.slice(1)}`);
        }

        // Re-render to update gold display
        renderGachaScreen();
    }


    function renderBattleScreen(isSurvival = false) {
        currentScreen = isSurvival ? 'SURVIVAL' : 'BATTLE';
        removeGuideElements();
        
        const ultimateSkill = Object.values(ULTIMATE_SKILLS)
            .concat(Object.values(ULTIMATE_SKILLS_2))
            .concat(Object.values(ULTIMATE_SKILLS_3))
            .flatMap(s => Object.values(s))
            .find(s => s.id === player.selectedUltimateId);
            
        root.innerHTML = `
            <div id="game-world">
                ${isSurvival ? `<h2 class="dungeon-progress" style="color: var(--survival-color);">ÏÑúÎ∞îÏù¥Î≤å - ${survivalWave} Ïõ®Ïù¥Î∏å</h2>` : renderDungeonMap()}
                <div class="character-card monster-card">
                    <h2>${monster.emoji} ${monster.name} ${monster.isBoss ? ' (Î≥¥Ïä§)' : ''}</h2>
                    <div class="hp-bar-container">
                        <div class="hp-bar" style="width: ${monster.currentHp / monster.maxHp * 100}%;"></div>
                    </div>
                    <p>${monster.currentHp.toLocaleString()} / ${monster.maxHp.toLocaleString()}</p>
                    <div class="status-effects" id="monster-status-effects"></div>
                </div>

                <div class="player-card">
                    ${renderPlayerCard(true)}
                </div>

                <div id="message-log" style="height: 100px; margin: 0.4rem 0;"></div>

                <div id="action-buttons">
                    <button data-action="attack" class="button">Í≥µÍ≤©</button>
                    <button data-action="use-potion" class="button" ${isSurvival ? 'disabled' : ''}>Î¨ºÏïΩ (${player.potions})</button>
                    <button data-action="use-attack-potion" class="button" ${isSurvival ? 'disabled' : ''}>Í≥µÍ≤© Î¨ºÏïΩ (${player.attackPotions})</button>
                    <button data-action="ultimate-skill" class="button" ${player.ultimateSkill.cooldownLeft > 0 ? 'disabled' : ''}>
                       ${ultimateSkill.name} ${player.ultimateSkill.cooldownLeft > 0 ? `(${player.ultimateSkill.cooldownLeft})` : ''}
                    </button>
                    ${!isSurvival ? `<button data-action="escape" class="button">ÎèÑÎßùÍ∞ÄÍ∏∞</button>` : ''}
                </div>
            </div>
        `;
        messageLog = document.getElementById('message-log');
        updateStatusEffectIcons('player-status-effects', player.statusEffects);
        updateStatusEffectIcons('monster-status-effects', monster.statusEffects);

        document.getElementById('action-buttons')?.addEventListener('click', (e) => {
            const action = e.target.closest('button')?.dataset.action;
            if (!action || e.target.closest('button').disabled) return;
            handleBattleAction(action, isSurvival);
        });
    }

    // --- Data Management ---
    function saveGameState() {
        if (!player) return;
        const gameState = {
            player,
            currentDifficulty,
            dungeonLevel,
            dungeonFloor,
            dailyQuests,
            lastQuestDate,
        };
        try {
            localStorage.setItem('simpleRPG_saveData', JSON.stringify(gameState));
        } catch (e) {
            console.error("Failed to save game state:", e);
        }
    }
    
    function loadGameState() {
        try {
            const savedData = localStorage.getItem('simpleRPG_saveData');
            if (savedData) {
                const gameState = JSON.parse(savedData);
                player = gameState.player;
                currentDifficulty = gameState.currentDifficulty || 'Î≥¥ÌÜµ';
                dungeonLevel = gameState.dungeonLevel || 1;
                dungeonFloor = gameState.dungeonFloor || 1;
                dailyQuests = gameState.dailyQuests || [];
                lastQuestDate = gameState.lastQuestDate || '';

                // Data migration for new features
                if (!player.rebirths) player.rebirths = 0;
                if (!player.rebirthPoints) player.rebirthPoints = 0;
                if (!player.rebirthUpgrades) player.rebirthUpgrades = {};
                if (!player.enhancementStones) player.enhancementStones = 0;
                if (!player.enchantmentDust) player.enchantmentDust = 0;
                if (!player.equipment.accessory) player.equipment.accessory = null;
                if (!player.equipment.relic) player.equipment.relic = null;
                if (!player.permanentQuests) player.permanentQuests = PERMANENT_QUESTS_DATA.map(q => ({...q, progress: 0, completed: false}));
                if (player.isLiberated === undefined) player.isLiberated = false;
                if (!player.selectedUltimateId) player.selectedUltimateId = ULTIMATE_SKILLS[player.className].id;
                if (!player.unlockedUltimates) player.unlockedUltimates = [ULTIMATE_SKILLS[player.className].id];
                player.inventory.forEach(item => {
                    if (item.isLocked === undefined) item.isLocked = false;
                    if (item.transcendenceLevel === undefined) item.transcendenceLevel = 0;
                });


                const today = new Date().toLocaleDateString();
                if (lastQuestDate !== today) {
                    generateNewDailyQuests();
                }

                updatePlayerStats();
                return true;
            }
            return false;
        } catch (e) {
            console.error("Failed to load game state:", e);
            return false;
        }
    }

    function deleteSaveData(showConfirmation = true) {
        localStorage.removeItem('simpleRPG_saveData');
        if (showConfirmation) {
            alert('Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            createStartScreen();
        }
    }


    // --- Game Logic ---
    function handleBattleAction(action, isSurvival = false) {
        if (player.currentHp <= 0) return;

        let playerTurn = false;
        switch(action) {
            case 'attack':
                playerAttack();
                playerTurn = true;
                break;
            case 'use-potion':
                if (player.potions > 0) {
                    const healAmount = Math.round(player.maxHp * POTION_HEAL_PERCENT);
                    player.currentHp = Math.min(player.maxHp, player.currentHp + healAmount);
                    player.potions--;
                    addMessage(`Î¨ºÏïΩÏùÑ ÏÇ¨Ïö©Ìï¥ ${healAmount}Ïùò HPÎ•º ÌöåÎ≥µÌñàÏäµÎãàÎã§.`, 'rarity-uncommon');
                    playerTurn = true;
                } else {
                    addMessage('Î¨ºÏïΩÏù¥ ÏóÜÏäµÎãàÎã§!', 'rarity-mythic');
                }
                break;
            case 'use-attack-potion':
                 if (player.attackPotions > 0) {
                    player.attackPotions--;
                    const buff = { stat: 'attackPower', value: 0.3, duration: 3, isPercent: true };
                    applyBuff(player, 'Í≥µÍ≤© Í∞ïÌôî', buff);
                    addMessage(`Í≥µÍ≤© Î¨ºÏïΩÏùÑ ÏÇ¨Ïö©Ìï¥ 3ÌÑ¥Í∞Ñ Í≥µÍ≤©Î†•Ïù¥ 30% Ï¶ùÍ∞ÄÌï©ÎãàÎã§!`, 'rarity-rare');
                    playerTurn = true;
                } else {
                    addMessage('Í≥µÍ≤© Î¨ºÏïΩÏù¥ ÏóÜÏäµÎãàÎã§!', 'rarity-mythic');
                }
                break;
            case 'ultimate-skill':
                if (player.ultimateSkill.cooldownLeft === 0) {
                    useUltimateSkill();
                    playerTurn = true;
                    updateQuestProgress('USE_ULTIMATE', 1);
                }
                break;
            case 'escape':
                handleEscape();
                return; // Escape ends the battle immediately
        }

        if (playerTurn) {
            if (monster.currentHp > 0) {
                // Apply player status effects before monster's turn
                applyStatusEffects(player, 'player');
                if (player.currentHp <= 0) {
                    handleDefeat(isSurvival);
                } else {
                    // Check for stun on player
                    if (!player.statusEffects.stun) {
                         setTimeout(() => monsterTurn(isSurvival), 500);
                    } else {
                         // Player is stunned, skip monster turn logic and proceed to next turn
                         setTimeout(() => endTurn(isSurvival), 500);
                    }
                }
            } else {
                handleVictory(isSurvival);
            }
        }
        
        // Always rerender after an action
        renderBattleScreen(isSurvival);
    }
    
    function handleEscape() {
        const goldPenalty = Math.round(player.gold * ESCAPE_GOLD_PENALTY);
        player.gold -= goldPenalty;
        alert(`Î¨¥ÏÇ¨Ìûà ÎèÑÎßùÏ≥§ÏßÄÎßå, ${goldPenalty} Í≥®ÎìúÎ•º ÏûÉÏóàÏäµÎãàÎã§.`);
        renderTownScreen();
    }
    
    function monsterTurn(isSurvival) {
        // Apply monster status effects before its turn
        applyStatusEffects(monster, 'monster');
        
        if (monster.currentHp <= 0) {
            handleVictory(isSurvival);
            renderBattleScreen(isSurvival);
            return;
        }

        if (monster.statusEffects.stun) {
            addMessage(`${monster.name}Ïù¥ Í∏∞Ï†àÌï¥ÏÑú ÏõÄÏßÅÏùº Ïàò ÏóÜÏäµÎãàÎã§.`, 'rarity-legendary');
        } else {
            monsterAttack();
            if (player.currentHp <= 0) {
                handleDefeat(isSurvival);
            }
        }
        
        endTurn(isSurvival);
        renderBattleScreen(isSurvival);
    }
    
    function endTurn(isSurvival) {
        updateBuffs(player);
        updateBuffs(monster); // Though monsters don't have buffs currently
        
        // Cooldown reduction
        if(player.ultimateSkill.cooldownLeft > 0) {
            const cooldownReduction = 1 + (player.rebirthUpgrades.ultimate_cooldown ? (player.rebirthUpgrades.ultimate_cooldown * 0.05) : 0);
            player.ultimateSkill.cooldownLeft = Math.max(0, player.ultimateSkill.cooldownLeft - cooldownReduction);
        }
        
        // Remove expired status effects
        updateStatusEffectsDuration(player);
        updateStatusEffectsDuration(monster);

        // Re-render to reflect changes
        renderBattleScreen(isSurvival);
    }


    window.onload = () => {
        createStartScreen();
    };
  </script>
</body>
</html>
